# 🔍 採用ダッシュボード数値表示問題 - 徹底的調査・検証計画

**作成日**: 2025-01-28 15:10
**ステータス**: 🟢 API・同期・レポート生成・Firestore全て正常。フロントエンドのキー不一致が主因。
**問題**: 表示が全て0のまま、APIではデータが存在

## 🎯 **可能性のある原因リスト**

### 1. **データソース問題** 🗂️
- [x] **A1**: スプレッドシートの実データが存在しない → ✅ **存在**
- [x] **A2**: スプレッドシートの列構造が変更されている → ✅ **問題なし**
- [x] **A3**: スプレッドシートの権限・アクセス問題 → ✅ **問題なし**
- [x] **A4**: Google Sheets APIの制限・エラー → ✅ **問題なし**
- [x] **A5**: 同期処理でのデータ変換エラー → ✅ **問題なし**

### 2. **Firestore問題** 🔥
- [x] **B1**: Firestoreへのデータ保存が失敗している → ✅ **保存成功**
- [x] **B2**: Firestoreのデータ構造が期待と異なる → ✅ **構造正常**
- [x] **B3**: Firestoreの読み取り権限・セキュリティルール → ✅ **問題なし**
- [x] **B4**: Firestoreのインデックス問題 → ✅ **インデックス追加済み**
- [x] **B5**: 週次レポート生成時のデータ集約エラー → ✅ **集約正常**

### 3. **API問題** 🔌
- [x] **C1**: 週次レポートAPI(/api/recruitment/weekly-reports)のロジックエラー → ✅ **正常**
- [x] **C2**: APIが返すデータ形式の不一致 → ✅ **正常**
- [x] **C3**: APIのクエリパラメータ解析エラー → ✅ **正常**
- [x] **C4**: APIのレスポンス変換エラー → ✅ **正常**
- [x] **C5**: APIの週ID処理エラー → ✅ **正常**

**🎯 API検証結果**:
- 2025-W25: applications=4, application_rejections=1, application_continuing=3
- 2025-W27: applications=13, application_rejections=7, application_continuing=6, interviews=1

### 4. **フロントエンド問題** 🖥️
- [x] **D1**: useWeeklyReportsフックのデータ取得エラー → ✅ **取得成功**
- [x] **D2**: 週選択ロジックの不整合 → ✅ **選択週はAPIと一致**
- [x] **D3**: generateRowValuesでのキー不一致 → ❌ **主因: APIはスネークケース、フロントはキャメルケースで参照**
- [ ] **D4**: テーブル生成時のデータマッピングエラー
- [ ] **D5**: 状態管理・レンダリングの問題

### 5. **データフロー問題** 🔄
- [x] **E1**: 週番号計算の不整合 → ✅ **一致**
- [x] **E2**: 日付範囲の不一致 → ✅ **一致**
- [x] **E3**: 職種フィルタリングの問題 → ✅ **一致**
- [x] **E4**: 媒体フィルタリングの問題 → ✅ **一致**
- [x] **E5**: データ集約ロジックの問題 → ✅ **一致**

### 6. **環境・設定問題** ⚙️
- [x] **F1**: 環境変数の設定問題 → ✅ **解消**
- [x] **F2**: Firebase設定の問題 → ✅ **解消**
- [x] **F3**: Next.jsビルド・キャッシュ問題 → ✅ **解消**
- [x] **F4**: TypeScript型定義の不整合 → ✅ **解消**
- [x] **F5**: 依存関係のバージョン問題 → ✅ **解消**

---

## 📝 **実データ検証ログ要約**

### ● スプレッドシート → Firestore同期
- 全シート合計: 682件の有効応募データを同期
- 各シートごとに有効データ数・スキップ数・エラー数も0
- Firestore同期ログも記録（undefinedエラーは除外済み）

### ● 週次レポート生成
- 2025-W27 各職種ごとにレポート生成・保存成功
  - SNS運用: 応募数4, 応募内不採用1, 応募内選考継続3
  - 動画クリエイター: 応募数1, 面接1, 応募内選考継続1
  - AIライター: 応募数1, 応募内不採用1
  - 撮影スタッフ: 応募数7, 応募内不採用5, 応募内選考継続2

### ● API直接テスト
- 2025-W25: applications=4, application_rejections=1, application_continuing=3
- 2025-W27: applications=13, application_rejections=7, application_continuing=6, interviews=1
- APIは正しい集約値を返却

### ● Firestore直接確認
- applications/weekly_reportsコレクションともに正しい件数・構造
- 週次レポートは各職種・週ごとに保存されている

---

## 🚨 **最終的な主因と今後のTODO**

- **主因: フロントエンドのgenerateRowValues等でAPIのスネークケース（application_rejections等）をキャメルケース（applicationRejections等）で参照しているため、値が0になる**
- **API/DB/同期/集約/型定義/環境は全て正常**

### 【TODO】
- [ ] generateRowValues等でスネークケースにも対応するロジックを追加
- [ ] テーブル描画時のキー変換（例: application_rejections→applicationRejections）を吸収
- [ ] 既存のキャメルケース参照箇所を一括修正
- [ ] テスト・検証

---

**2025-01-28 進捗: API・同期・DB・集約は全て正常。フロントのキー不一致のみが残課題。** 