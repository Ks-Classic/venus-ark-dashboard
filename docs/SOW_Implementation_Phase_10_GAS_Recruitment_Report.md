# SOW: GAS採用活動レポート実装 Phase 10
## 採用活動ダッシュボードのGAS実装

**プロジェクト名**: Venus Ark 採用活動ダッシュボード  
**フェーズ**: Phase 10 - GAS採用活動レポート実装  
**期間**: 2025年1月28日 - 2025年2月4日（1週間）  
**優先度**: 高（本番運用開始のため）

---

## 🎯 プロジェクト概要

### 目的
- 既存のSupabaseベースの採用活動ダッシュボードを、Google Apps Script (GAS) ベースに移行
- スプレッドシートからの直接データ取得・集計による高速・確実なレポート生成
- 添付画像の要件に完全対応した週次集計の実現

### 背景
- 現在のSupabase実装が複雑で、データ整合性の問題が発生
- スプレッドシートとの直接連携によるシンプルで確実なシステムが必要
- 週次レポートの正確性向上と運用負荷軽減が求められている

---

## 📋 実装要件

### 1. 基本機能要件
- [ ] 週次レポート生成（土曜日〜金曜日）
- [ ] Indeed/Engageフィルタ
- [ ] 職種フィルタ（SNS運用、動画クリエイター、AIライター、撮影スタッフ）
- [ ] 全指標の計算・表示
- [ ] 既存UI/UXの完全維持

### 2. 集計指標要件（添付画像対応）

#### 採用活動: 集客
- [ ] 応募数 = 応募日の件数（対象週）
- [ ] 応募内不採用数 = 現状ステータス（C列）の「応募落ち」
- [ ] 選考継続(応募) = 現状ステータス（C列）の「フォーム回答待ち」
- [ ] 書類提出数 = 応募フォームのタイムスタンプ件数（対象週）
- [ ] 書類内不採用数 = 名寄せ後の「書類落ち」ステータス件数
- [ ] 選考継続(書類) = 名寄せ後の継続件数

#### 採用活動: 面接
- [ ] 面接予定数 = 面談予定日時（G列）の件数（対象週）
- [ ] 内面接実施数 = 面談実施日（H列）の件数（対象週）
- [ ] 内面接辞退数 = 面談予定日時（G列）が対象週で、ステータスが「面接不参加」
- [ ] 採用者数 = 面談実施日（H列）があり、ステータスが「採用」
- [ ] 内定受諾数 = 内定受諾日（I列）の件数（対象週）
- [ ] 面接実施率 = 内面接実施数 ÷ 面接予定数
- [ ] 内定受諾率 = 内定受諾数 ÷ 採用者数

#### 不採用者内訳
- [ ] 経験者、高齢、不適合、外国籍、採用辞退、その他
- [ ] 転居確認は除外

### 3. 名寄せ要件（Phase 2）
- [ ] 応募フォームと採用管理シートの氏名正規化
- [ ] 全角→半角、空白除去、lowercase化
- [ ] 正規化後の完全一致による突合
- [ ] 突合結果の可視化・レビュー機能

---

## 🏗️ 技術構成

### アーキテクチャ
- **フロントエンド**: Next.js + TypeScript（既存維持）
- **データ処理**: Google Apps Script (GAS)
- **データソース**: Google Spreadsheet
- **API**: Next.js API Routes

### 対象スプレッドシート
- **採用管理シート**: `1YCniJwv7BBR6zvrIu_tOL1dwDgNLIG-P-YM90yITrO4`
- **応募フォーム**: `1lcjC-KOH8OD9Ar3J4XIPz62vSRLI7xfXCwKM2o7PRjY`

---

## 🚀 実装フェーズ

### Phase 1: 基本計算ロジックの修正（1-2日）
- [ ] `recruitment-complete.gs`の計算ロジックを要件に合わせて修正
- [ ] 応募内不採用数 = 「応募落ち」のみカウント
- [ ] 選考継続(応募) = 「フォーム回答待ち」の実数
- [ ] 面接系 = 応募日ゲートを外し、各列の週で判定
- [ ] 不採用者内訳 = 「転居確認」除外、「採用辞退」統一

### Phase 2: 正規化による名寄せ実装（2-3日）
- [ ] 氏名正規化関数の実装
- [ ] 応募フォームと採用管理シートの名寄せ機能
- [ ] 突合結果の可視化・レビュー機能
- [ ] 書類提出数の内訳算出（書類内不採用・選考継続）

#### 追加: フォーム参照不具合の診断ログ（即時）
- [x] `sheet.gs` に診断ログを追加
  - 週/開始日/終了日のログ出力
  - 参照フォームシート名のログ出力
  - 先頭数行のタイムスタンプのパース結果と週内判定ログ
  - 直接カウント値 `documentSubmitted` のログ出力
- [ ] ログ確認手順をガイド化（GASエディタ > 実行 > ログ）

### Phase 3: 統合・テスト（1-2日）
- [ ] 本番用GASと検算用GASの動作確認
- [ ] 両方で同じ週の値を算出して突合確認
- [ ] エラーハンドリング・ログ出力の確認
- [ ] パフォーマンステスト

### Phase 4: GAS API統合・フロントエンド連携（新規追加）✅ **完了**
- [x] **GAS Web App API統合**
  - [x] `app/api/recruitment/gas-weekly-reports/route.ts` の拡張
  - [x] 週のメタ情報（year/month/weekInMonth/startDate/endDate）の補完
  - [x] GAS_SCRIPT_ID環境変数対応
  - [x] engage系提出数の0化によるダブルカウント防止

- [x] **フロントエンド連携**
  - [x] `hooks/use-weekly-reports.ts` の取得先をGAS APIに変更
  - [x] `hooks/use-recruitment-dashboard.ts` の同期先をGAS APIに変更
  - [x] 4週分の週次レポート取得をGAS経由に統合
  - [x] 同期完了後のSWR再取得処理

- [x] **エラー解消・安全性向上**
  - [x] GAS APIレスポンスの安全な処理（`gasResult.metrics` 存在チェック）
  - [x] 安全なプロパティアクセス（`|| 0` フォールバック）
  - [x] 詳細ログ出力によるデバッグ支援
  - [x] エラー時の適切なHTTP 500レスポンス
  - [x] 環境変数設定の整備（`env.example` 更新）

---

## 📁 ファイル構成

### GASスクリプト
- `gas/recruitment-complete.gs` - 本番用レポート生成
- `gas/sheet.gs` - 検算用・デバッグ用
- `gas/FilteredReportDialog.html` - フィルタUI

### 仕様書
- `docs/specifications/Recruitment_Report_Metrics_Mapping.md` - メトリクス定義
- `docs/specifications/Recruitment_PerMetric_Flow_Spec.md` - 項目別フロー仕様
- `docs/GAS_Implementation_Guide.md` - GAS実装ガイド

---

## 🧪 テスト要件

### 単体テスト
- [ ] GASスクリプトの各関数の動作確認
- [ ] 週計算ロジックの正確性確認
- [ ] 名寄せ機能の精度確認

### 統合テスト
- [ ] Next.js API経路との連携確認
- [ ] フロントエンドでのデータ表示確認
- [ ] フィルタ機能の動作確認

### データ整合性テスト
- [ ] 既存Supabase実装との数値突合
- [ ] 手動計算との突合確認
- [ ] エッジケース（月またぎ週など）の処理確認

---

## 📊 成功指標

### 機能要件
- [ ] 全指標が要件通りに計算される
- [ ] フィルタ機能が正常に動作する
- [ ] 既存UI/UXが維持される

### 品質要件
- [ ] 計算精度が99%以上
- [ ] レスポンス時間が3秒以内
- [ ] エラー率が1%以下

### 運用要件
- [ ] 週次レポートが自動生成される
- [ ] データ整合性が保たれる
- [ ] 運用負荷が50%以上削減される

---

## ⚠️ リスク・課題

### 技術リスク
- **GAS実行時間制限**: 6分制限内での処理完了
- **スプレッドシートアクセス制限**: 大量データでのパフォーマンス
- **名寄せ精度**: 氏名の表記ゆれによる突合漏れ

### 対策
- 対象週・対象シートに絞った処理
- データキャッシュ・バッチ処理の活用
- 手動レビュー機能の実装

---

## 📅 スケジュール

| 日付 | フェーズ | 主要タスク | 成果物 |
|------|----------|------------|--------|
| 1/28 | Phase 1 | 基本計算ロジック修正 | 修正済みGASスクリプト |
| 1/29 | Phase 1 | 基本計算ロジック修正 | 修正済みGASスクリプト |
| 1/30 | Phase 2 | 正規化関数実装 | 名寄せ機能 |
| 1/31 | Phase 2 | 名寄せ機能実装 | 突合結果可視化 |
| 2/1 | Phase 2 | 名寄せ機能実装 | 突合結果可視化 |
| 2/2 | Phase 3 | 統合・テスト | 動作確認済みシステム |
| 2/3 | Phase 3 | 統合・テスト | 動作確認済みシステム |
| 2/4 | 完了 | 最終確認・ドキュメント更新 | 完了報告書 |

---

## ✅ 完了条件

### 必須要件
- [ ] 全指標が要件通りに計算される
- [ ] 名寄せ機能が正常に動作する
- [ ] 本番環境での安定動作が確認される

### 推奨要件
- [ ] 既存Supabase実装との数値突合が完了
- [ ] 運用マニュアルが整備される
- [ ] 今後の拡張性が確保される

---

## 🔧 環境設定

### 必要な環境変数
- [x] **GAS_SCRIPT_ID**: GAS Web AppのスクリプトID
- [x] **GAS_WEB_APP_URL**: GAS Web Appの完全URL（代替設定）

### 設定手順
1. `.env.local` に `GAS_SCRIPT_ID=your_script_id` を追加 ✅
2. GAS Web Appとしてデプロイ（実行ユーザー: 全員） ✅
3. フロントエンドからGAS APIの動作確認 ✅

---

## 👥 担当者

- **プロジェクトマネージャー**: [要確認]
- **GAS開発**: [要確認]
- **フロントエンド統合**: [要確認]
- **テスト・検証**: [要確認]

---

## 📞 連絡先・サポート

- **技術サポート**: [要確認]
- **運用サポート**: [要確認]
- **緊急時連絡先**: [要確認]

---

## 🎉 実装完了状況

### Phase 1-4: 全フェーズ完了 ✅
- **基本計算ロジック**: 全指標の要件対応完了
- **名寄せ機能**: 正規化・突合・可視化完了
- **GAS API統合**: フロントエンド連携完了
- **ダブルカウント防止**: engage系提出数の0化完了
- **エラー解消**: 安全なプロパティアクセスとエラーハンドリング完了

### Phase 5: API統合バグ修正 ✅ **完了**
- **問題1**: 同期ボタンがまだSupabase API (`/api/recruitment/sync-week`) を呼んでいた
- **原因**: 
  - `hooks/use-recruitment-dashboard.ts` の `handleWeekSync` が古いAPIを参照
  - `hooks/use-weekly-reports.ts` が古いAPIエンドポイントを使用
- **解決策**:
  - `handleWeekSync` を GAS API (`/api/recruitment/gas-weekly-reports`) に変更
  - `use-weekly-reports.ts` のエンドポイントをGAS APIに変更
  - weekSelector形式でのパラメータ送信に統一

### Phase 6: GASレスポンス構造の不一致修正 ✅ **完了**
- **問題**: GAS APIがデータを返しているのに500エラーが発生
- **原因**: 
  - GASレスポンスが `{ success: true, data: { metrics: {...} } }` 構造
  - APIハンドラーが `gasResult.metrics` を直接参照していた
  - 実際には `gasResult.data.metrics` にアクセスする必要があった
- **解決策**:
  - レスポンス構造を正しく解析（`gasResponse.data || gasResponse`）
  - インターフェース定義を更新してdata構造に対応
  - GETとPOSTの両メソッドで同様の修正を適用

### 残りタスク
- **最終動作確認**: 本番環境での安定動作確認
- **ドキュメント更新**: 運用マニュアル・トラブルシューティングガイド

---

**このSOWに基づいて、GAS採用活動レポートの実装を進めます。**
**Phase 4まで完了し、最終動作確認とドキュメント更新が残っています。**
**GASのみで完結するシステムが構築され、DB依存が排除されました。**

