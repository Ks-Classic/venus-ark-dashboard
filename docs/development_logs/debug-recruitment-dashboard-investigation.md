# 採用ダッシュボード エラー調査ログ

## 1. 問題の概要

- **現象:** 採用ダッシュボードにレポートが表示されない。
- **エラー:** フロントエンドはAPI (`/api/recruitment/weekly-reports`) から500 (Internal Server Error) を受け取っている。
- **副次的な問題:** 「スプレッドシートから同期」ボタンが押せない状態になっている。

## 2. 初期仮説

- **仮説A: データの問題:** Firestoreの`weekly_reports`コレクションに、特定の週のデータが破損または予期しない形式で格納されている可能性がある。
- **仮説B: APIロジックの問題:** データの集計やマージ処理に、まだ発見されていないエッジケースや不具合が存在する。
- **仮説C: 環境/設定の問題:** Firebase Admin SDKの初期化や、関連する環境変数の読み込みに失敗している。

## 3. 調査計画とTODO

### フェーズ1: 原因の切り分け

- [ ] **タスク1: Firestoreデータ直接取得テスト (仮説Aの検証)**
  - **目的:** APIを介さず、Admin SDKを使って直接Firestoreから問題の週のデータを取得し、データ自体が破損していないか確認する。
  - **方法:** `scripts/debug-direct-firestore-fetch.ts` を作成し、`year=2025`, `month=5` のデータを取得してコンソールに出力する。
  - **期待される結果:** データが正常に取得できるか、あるいはシリアライズエラーなどが発生するかを確認する。

- [ ] **タスク2: APIロジックの詳細ロギング (仮説Bの検証)**
  - **目的:** APIルート (`app/api/recruitment/weekly-reports/route.ts`) の処理フローを詳細に追跡し、エラー発生箇所を特定する。
  - **方法:** `try...catch`ブロックの各ステップ（DB接続、クエリ実行、データ集計）で、処理中の変数や結果をコンソールにログ出力するコードを追加する。
  - **期待される結果:** サーバーログから、どの行で処理が失敗しているかを特定する。

- [ ] **タスク3: フロントエンドの状態調査 (副次的問題の調査)**
  - **目的:** 「スプレッドシートから同期」ボタンがなぜ無効になっているかを解明する。
  - **方法:** `components/recruitment-dashboard.tsx` を読み、ボタンの `disabled` 属性がどのstateによって制御されているかを確認する。`useWeeklyReports` フックの `loading` 状態が影響している可能性が高い。
  - **期待される結果:** ボタンが無効化される論理的な条件を特定する。

### フェーズ2: 修正と検証

- [ ] **タスク4: 修正コードの実装**
  - **目的:** フェーズ1で特定した原因に基づき、コードを修正する。
  - **方法:** (特定された原因に応じて決定)

- [ ] **タスク5: 動作確認**
  - **目的:** 修正によって問題が解決されたことを確認する。
  - **方法:** アプリケーションを再起動し、採用ダッシュボードが正常に表示されること、および同期ボタンが操作可能になることを確認する。

## 4. 調査の記録

### タスク1: Firestoreデータ直接取得テスト

- **実行日:** 2025-07-16
- **結果:** スクリプトの実行に成功し、Firebaseに接続できた。しかし、Firestoreへのクエリ実行時に `FAILED_PRECONDITION: The query requires an index` というエラーが返された。
- **考察:** **これが根本原因である。** APIが使用しているクエリ (`.where('reportType', '==', 'recruitment').where('startDate', '>=', startDateStr).where('startDate', '<=', endDateStr)`) を実行するためには、Firestoreに複合インデックスが事前に作成されている必要がある。このインデックスが存在しないため、データベースがクエリを拒否し、それがAPIの500エラーを引き起こしていた。
- **次のステップ:** 必要なインデックスを作成する。 

