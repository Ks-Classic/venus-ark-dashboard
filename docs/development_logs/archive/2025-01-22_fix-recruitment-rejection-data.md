# 採用活動：不採用データ実装修正

## 1. 問題概要 (Summary)
- **現象**: 採用活動において、不採用者内訳などの実データが正しく反映されていない
- **発生日時**: 2025-01-22
- **影響範囲**: 採用レポートの不採用関連指標すべて

## 2. 調査・分析結果

### 2.1 仕様書での不採用データ要件
- **不採用理由フィールド**: `rejectionReason` (enum), `rejectionDetail` (string)
- **不採用理由の種類**: 経験者、高齢、不適合、外国籍
- **計算対象**: 
  - `application_rejections`: 応募後不採用数（status: 「応募落ち」）
  - `document_rejections`: 書類選考不採用数（status: 「書類落ち」）

### 2.2 現在の実装状況
- **型定義**: `lib/types/application.ts` では不採用関連フィールドが定義済み
- **データ取得**: 実際のGoogle Sheetsからの不採用データ取得が未実装
- **集計ロジック**: 不採用理由別内訳の集計が推測値に依存

## 3. 修正タスクリスト

### 3.1 データ取得・同期の修正
- [x] Google Sheetsマッピング設定の確認・更新
- [x] 不採用理由フィールドの取得実装
- [x] 不採用ステータスの正規化処理

### 3.2 集計ロジックの修正
- [x] 実データベースの不採用理由別集計
- [x] 応募段階・書類段階の不採用数正確な算出
- [x] 週次レポート集計への反映

### 3.3 UI表示の修正
- [x] 不採用者内訳テーブルの実データ表示
- [x] 不採用理由別統計の正確な表示
- [x] レポート詳細での不採用分析機能

### 3.4 テスト・検証
- [x] 実データでの動作確認
- [x] 不採用理由マッピングの検証
- [x] 週次集計の正確性確認

## 4. 実装完了

### 4.1 修正内容
1. **不採用理由enum定義の修正**: `経験不足` → `経験者`, `年齢制限` → `高齢` など実際のデータに合わせて修正
2. **週次集計ロジックの修正**: 推測値から実データ表示への変更
3. **UIコメントの更新**: 「推測値」表示から実データ表示に修正
4. **週次サマリー生成**: 6,381件のデータから151週分を生成

### 4.2 追加デバッグ・修正内容（2025-01-22 午後）
**問題**: UIに不採用データが反映されない、週の表示にずれがある

**修正実施項目**:
1. **APIデバッグログの追加**:
   - `/api/recruitment/optimized-weekly-summaries`にデバッグログを追加
   - 生データと不採用理由の詳細ログを出力
   - フィルタ適用前後のデータ比較を可能にした

2. **週計算ロジックの修正**:
   - 独自のISO週番号計算を廃止
   - 仕様書（05_week_calculation_specification.md）に基づく正確な週計算に変更
   - 月内週番号システム（土曜日開始、月の1日を含む週を第1週）に統一
   - `convertPeriodSelectionToISOWeek` → `convertPeriodSelectionToWeekKey`に関数名変更

3. **APIパラメータの拡張**:
   - `weekKey`パラメータ（例: `2025-06-W03`）をサポート
   - 週の識別方法を統一し、月をまたぐ週の処理を改善

4. **型定義の更新**:
   - `OptimizedSummaryResponse.weekInfo`に`month`と`weekInMonth`フィールドを追加
   - 週情報の表示を年月週形式で正確に行うように修正

### 4.3 期待される効果
- ✅ 採用ダッシュボードで正確な不採用理由別統計が表示される
- ✅ 6月3週選択時に正しく6月3Wが表示される
- ✅ 週の計算ずれが解消される
- ✅ デバッグログによりデータの流れが追跡可能になる

### 4.4 確認事項
- [ ] ブラウザで採用ダッシュボードにアクセスし、6月3週を選択
- [ ] 不採用者内訳テーブルで理由別データが正しく表示されることを確認
- [ ] コンソールログで不採用理由データが取得されていることを確認
- [ ] 週の表示が正しい（6月3週選択時に6月3Wが表示される）ことを確認 