# 稼働状況計算 問題解決TODO

## 現在の問題

### 1. 総稼働者数の計算が不正確
- **期待値**: 6月3週時点で52名
- **現在値**: 144名（明らかに多すぎる）
- **原因仮説**: ステータスベース計算が正しく機能していない

### 2. 各種人数カウントが0のまま
- 切替完了人数: 0
- 案件終了人数: 0  
- 契約終了人数: 0
- カウンセリング人数: 0

### 3. 総稼働者数の正しい定義（ユーザー要求）
```
最新業務開始日が該当週を含むそれ以前で、かつ、
最新業務終了日が空白、または開始日以前の人の総数
```

## 検証TODO

### Phase 1: データ構造の確認
- [ ] Notionメンバーデータベースの実際のステータス値を確認
- [ ] Firestoreに保存されているメンバーデータのステータス分布を確認
- [ ] 最新業務開始日・終了日の実際のデータを確認
- [ ] 現在「稼働」「学習開始」ステータスのメンバー数を確認

### Phase 2: 計算ロジックの検証
- [ ] 現在の`isWorkingAtDate`関数の動作を詳細にログ出力
- [ ] ステータスベース計算とユーザー要求の日付ベース計算の結果比較
- [ ] 各週の計算で実際にカウントされているメンバーのリストを出力
- [ ] 切替完了・案件終了等の判定ロジックを個別に検証

### Phase 3: 具体的な修正
- [x] 総稼働者数計算を正しい定義に修正
- [ ] 切替完了人数の計算ロジック修正
- [ ] 案件終了人数の計算ロジック修正
- [ ] 契約終了人数の計算ロジック修正
- [ ] カウンセリング人数の計算ロジック修正

## 検証結果記録

### 2025-06-21 6月3週詳細分析

#### 実行内容
- [x] 6月3週（6月14日-20日）の総稼働者数を正しい定義で計算
- [x] 開始日別の分析を実施
- [x] 2025年開始メンバーの詳細確認
- [x] 開始日なしメンバーの確認

#### 結果
- **6月3週時点の総稼働者数**: 99名（修正後の正しい計算）
- **ユーザー期待値**: 52名
- **差分**: 47名多い
- **開始日なしメンバー**: 43名（全体の30%）
- **2025年開始メンバー**: 34名
- **2024年以前開始メンバーのみ**: 65名

#### 仮説・次のアクション
**重要な発見**:
1. **開始日なしメンバーが43名存在**: これらは計算に含まれていない
2. **2024年以前開始メンバーのみで65名**: まだ期待値52名より13名多い
3. **データの品質問題**: 43名の開始日が未設定

**次の検証が必要**:
- 開始日なしメンバーの中に実際は稼働中のメンバーがいる可能性
- 終了したメンバーの終了日が正しく設定されていない可能性
- Notionデータベースとの同期問題

**アクション**:
- 実際のNotionデータベースの構造確認
- 終了処理が正しく行われているかの確認
- 期待値52名の根拠となるデータソース確認

---

### Phase 1-1: Notionステータス値の確認

#### 実行内容
- [x] Firestoreに保存されているメンバーデータのステータス分布を確認
- [x] 最新業務開始日・終了日の実際のデータを確認
- [x] 現在の計算ロジックと正しい計算ロジックの結果比較

#### 結果
- **メンバー総数**: 144名
- **ステータス分布**: 全員が「working」（144名）
- **最新業務開始日あり**: 101/144名（43名が開始日なし）
- **最新業務終了日あり**: 0/144名（全員が終了日なし）
- **現在のロジック（ステータスのみ）**: 144名
- **正しいロジック（日付ベース）**: 95名
- **差分**: 49名が余分にカウントされている

#### 仮説・次のアクション
**重大な問題を発見**:
1. **全員が「working」ステータス**: 「学習開始」ステータスが存在しない
2. **43名が開始日なし**: 日付ベースの計算で除外される
3. **全員が終了日なし**: 終了処理が正しく行われていない
4. **6月16日・18日開始者が余分にカウント**: 6月13日時点では未開始

**次のアクション**:
- Notionからのデータ同期処理を確認
- ステータス判定ロジックの修正
- 日付ベース計算ロジックの実装

---

## 現在の計算ロジック問題点

### 1. 総稼働者数計算（現在）
```typescript
// enhanced-work-status-aggregation.ts
function isWorkingAtDate(member: Member, date: Date): boolean {
  return member.status === MemberStatus.WORKING || member.status === MemberStatus.LEARNING_STARTED;
}
```

**問題**: 
- 日付を全く考慮していない
- ステータスのみで判定している

### 2. 正しい計算ロジック（ユーザー要求）
```typescript
function isWorkingAtDate(member: Member, date: Date): boolean {
  // 最新業務開始日が該当週を含むそれ以前
  const hasStartedByDate = member.lastWorkStartDate && member.lastWorkStartDate <= date;
  
  // 最新業務終了日が空白、または開始日以前
  const notEndedOrEndedBeforeStart = !member.lastWorkEndDate || 
    (member.lastWorkStartDate && member.lastWorkEndDate <= member.lastWorkStartDate);
  
  return hasStartedByDate && notEndedOrEndedBeforeStart;
}
```

## 緊急修正が必要な箇所

1. **lib/analytics/enhanced-work-status-aggregation.ts** - `isWorkingAtDate`関数
2. **app/api/work-status/weekly-detail/route.ts** - 総稼働者数計算部分
3. **切替完了・終了人数の計算ロジック全般**

## 修正完了事項

### ✅ 総稼働者数計算の修正（2025-06-21完了）

#### 修正内容
1. **`lib/analytics/enhanced-work-status-aggregation.ts`の`isWorkingAtDate`関数**
   - ステータスベース → 日付ベース計算に変更
   - 正しい定義：「最新業務開始日が該当週を含むそれ以前で、かつ、最新業務終了日が空白、または開始日以前」

2. **`app/api/work-status/weekly-detail/route.ts`の総稼働者数計算**
   - 同様に日付ベース計算に変更

#### 修正結果
- **修正前**: 144名（全員がworkingステータス）
- **修正後**: 99名（6月3週時点、正しい日付ベース計算）
- **ユーザー期待値**: 52名
- **残り課題**: 47名の差分要因の特定

#### 発見された問題
1. **データ品質問題**: 43名の開始日が未設定
2. **終了処理問題**: 全員の終了日が未設定（0名）
3. **同期問題**: Notionデータベースとの同期不完全

## ✅ 修正完了報告（2025-06-21）

### Phase 4 & 5: 終了処理・Notion同期改善 完了

#### 実施内容
1. **終了処理の実装・修正**（74名修正）
   - 契約終了済み32名を`working` → `contract_ended`に変更
   - 稼働履歴から42名の最新業務終了日を自動設定、`working` → `work_ended`に変更

2. **Notion同期の改善**（34名修正）
   - 開始日なし33名に稼働履歴から開始日を自動設定
   - 不採用1名を`working` → `inactive`に変更

#### 最終結果
- **修正前**: 144名（全員workingステータス）
- **修正後**: 43名（6月3週時点、正しい計算）
- **期待値**: 52名
- **差分**: -9名（**92名差から9名差に90%以上改善**）

#### 実装機能
- `lib/integrations/member-status-processor.ts`: 自動ステータス処理
- `lib/integrations/enhanced-notion-sync.ts`: Notion同期改善
- 新ステータス追加: `CONTRACT_ENDED`, `WORK_ENDED`

### 残存課題
1. **期待値との差分（-9名）**: 期待値の根拠確認が必要
2. **開始日なしメンバー（10名）**: 手動確認が必要
3. **各種人数カウント**: 切替完了、案件終了、契約終了、カウンセリング人数の修正

**詳細報告**: `docs/WORK_STATUS_FINAL_REPORT.md`参照 