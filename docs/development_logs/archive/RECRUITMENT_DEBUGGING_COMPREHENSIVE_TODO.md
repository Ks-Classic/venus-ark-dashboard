# 採用活動エラー解決 総合TODO

## 🎯 解決すべき問題

### 1. 週ずれ問題
> **6月3週なら6月3Wに値が出ないといけないが、選択期間と値が反映される週がずれている**

### 2. データ表示問題
> **内不採用数や不採用者内訳などのデータが0になっている**

---

## 📋 Phase 1: 現状把握・問題分析

### [✅] 1.1 週計算ロジックの検証
- [✅] `lib/analytics/weekly-aggregation.ts`の`getWeekRange`関数の動作を確認
  - **検証項目**: 土曜日開始週の計算が正しいか
  - **検証方法**: 具体的な日付での計算結果を確認
  - **記録**: 
    - 実行結果: 6月3週→2025-W25、6月4週→2025-W26など全て正常
    - 判定: ✅ 正常動作確認
    - 次のアクション: 他の箇所に問題原因を探す

- [✅] `hooks/use-optimized-weekly-summaries.ts`の`convertPeriodSelectionToISOWeek`関数を確認
  - **検証項目**: 期間選択（6月3週）からISO週番号への変換が正しいか
  - **検証方法**: 6月3週が正しい週番号に変換されるかテスト
  - **記録**: 
    - 実行結果: 6月3週→2025-W25に正しく変換される
    - 判定: ✅ 正常動作確認
    - 次のアクション: データ保存・取得フローを調査

- [✅] `components/recruitment-dashboard.tsx`の週ラベル計算を確認
  - **検証項目**: `6月3W`表示と実際のデータ取得週が一致するか
  - **検証方法**: 表示と実際のAPI呼び出しパラメータを比較
  - **記録**: 
    - 実行結果: 週範囲2025-06-21〜2025-06-27→6月3Wラベル、完全一致
    - 判定: ✅ 正常動作確認
    - 次のアクション: データベースのデータ実態を調査 

### [ ] 1.2 データ取得フローの検証
- [ ] 期間選択→API呼び出し→データ表示の流れを追跡
  - **検証項目**: 各段階でのパラメータ値が正しく受け渡されているか
  - **検証方法**: コンソールログを追加して全段階のパラメータを確認
  - **記録**: 
    - 実行結果: 
    - 判定: 
    - 次のアクション: 

- [ ] `/api/recruitment/optimized-weekly-summaries`の応答データを確認
  - **検証項目**: 期待される週のデータが返されているか
  - **検証方法**: 具体的なAPI呼び出しでレスポンス内容を確認
  - **記録**: 
    - 実行結果: 
    - 判定: 
    - 次のアクション: 

### [ ] 1.3 ステータス値の実態調査
- [ ] Firestoreの`applications`コレクションの実データを確認
  - **検証項目**: 実際のステータス値の分布を確認
  - **検証方法**: 集計クエリを実行して各ステータス値の件数を確認
  - **記録**: 
    - 実行結果: 
    - 判定: 
    - 次のアクション: 

- [ ] `応募落ち`、`書類落ち`、`不採用`ステータスの使い分けを確認
  - **検証項目**: 定義通りにステータスが使われているか
  - **検証方法**: 各ステータスを持つレコードの詳細を確認
  - **記録**: 
    - 実行結果: 
    - 判定: 
    - 次のアクション: 

---

## 📋 Phase 2: 内不採用数ゼロ問題の詳細調査

### [ ] 2.1 メトリクス計算ロジックの検証
- [ ] `calculateRecruitmentMetrics`関数の各計算を段階的に確認
  - **検証項目**: 応募数、内不採用数、書類内不採用数の計算が正しいか
  - **検証方法**: 実データを使って各段階の計算結果を確認
  - **記録**: 
    - 実行結果: 
    - 判定: 
    - 次のアクション: 

- [ ] フィルタリング条件の妥当性を確認
  - **検証項目**: 期間フィルタと ステータスフィルタが正しく動作するか
  - **検証方法**: 条件を満たすデータが存在するかを確認
  - **記録**: 
    - 実行結果: 
    - 判定: 
    - 次のアクション: 

### [ ] 2.2 不採用理由内訳の調査
- [ ] `calculateRejectionBreakdown`関数の動作を確認
  - **検証項目**: 不採用理由の分類が正しく行われているか
  - **検証方法**: 実データで各理由の分類結果を確認
  - **記録**: 
    - 実行結果: 
    - 判定: 
    - 次のアクション: 

- [ ] 不採用理由フィールドの値を確認
  - **検証項目**: `rejectionReason`フィールドに期待される値が入っているか
  - **検証方法**: 実データのサンプルを確認
  - **記録**: 
    - 実行結果: 
    - 判定: 
    - 次のアクション: 

### [ ] 2.3 データ集計・保存フローの検証
- [ ] 週次サマリー生成スクリプトの動作を確認
  - **検証項目**: `generate-optimized-weekly-summaries.ts`が正しく動作するか
  - **検証方法**: スクリプトを実行して生成されるデータを確認
  - **記録**: 
    - 実行結果: 
    - 判定: 
    - 次のアクション: 

- [ ] Firestoreの`optimized_weekly_summaries`コレクションの実データを確認
  - **検証項目**: 保存されたサマリーデータが正しいか
  - **検証方法**: 特定週のドキュメント詳細を確認
  - **記録**: 
    - 実行結果: 
    - 判定: 
    - 次のアクション: 

---

## 📋 Phase 3: UI表示問題の調査

### [ ] 3.1 コンポーネント間のデータ受け渡しを確認
- [ ] `components/recruitment-dashboard.tsx`のデータ変換ロジックを確認
  - **検証項目**: APIから受け取ったデータが正しく表示用に変換されているか
  - **検証方法**: データ変換の各段階でログを確認
  - **記録**: 
    - 実行結果: 
    - 判定: 
    - 次のアクション: 

- [ ] `weeklyMetrics`の計算ロジックを確認
  - **検証項目**: 不採用数の推測計算が正しく行われているか
  - **検証方法**: 推測値と実際値を比較
  - **記録**: 
    - 実行結果: 
    - 判定: 
    - 次のアクション: 

### [ ] 3.2 表示フォーマットの検証
- [ ] 週ラベル表示（6月3W）の計算を確認
  - **検証項目**: 実際のデータの週と表示される週ラベルが一致するか
  - **検証方法**: 特定の週でデータと表示を比較
  - **記録**: 
    - 実行結果: 
    - 判定: 
    - 次のアクション: 

- [ ] 過去4週の選択・表示ロジックを確認
  - **検証項目**: 選択週を含む正しい4週のデータが表示されているか
  - **検証方法**: 選択週の前後の週で表示内容を確認
  - **記録**: 
    - 実行結果: 
    - 判定: 
    - 次のアクション: 

---

## 📋 Phase 4: 個別の問題解決

### [ ] 4.1 週ずれ問題の修正
- [ ] 根本原因の特定完了後、修正方針を決定
  - **修正方針**: 
  - **対象ファイル**: 
  - **修正内容**: 
  - **テスト方法**: 

- [ ] 修正の実装
  - **実装結果**: 
  - **テスト結果**: 
  - **残課題**: 

### [ ] 4.2 内不採用数ゼロ問題の修正
- [ ] 根本原因の特定完了後、修正方針を決定
  - **修正方針**: 
  - **対象ファイル**: 
  - **修正内容**: 
  - **テスト方法**: 

- [ ] 修正の実装
  - **実装結果**: 
  - **テスト結果**: 
  - **残課題**: 

---

## 📋 Phase 5: 総合テスト・検証

### [ ] 5.1 修正後の動作確認
- [ ] 週選択と表示の一致確認
  - **テスト方法**: 複数の週で選択と表示を確認
  - **テスト結果**: 
  - **問題点**: 

- [ ] 内不採用数の正常表示確認
  - **テスト方法**: 実際のデータで各項目の表示を確認
  - **テスト結果**: 
  - **問題点**: 

### [ ] 5.2 エッジケースのテスト
- [ ] 年またぎ週の表示確認
  - **テスト結果**: 
  - **問題点**: 

- [ ] データが存在しない週の表示確認
  - **テスト結果**: 
  - **問題点**: 

---

## 🔍 検証用コマンド・スクリプト

### データ確認用
```powershell
# 特定週のサマリーデータ確認
npx tsx scripts/debug-optimized-summaries.ts

# 応募データの実態確認
npx tsx scripts/debug-recruitment-data.ts

# API応答テスト
npx tsx scripts/test-api-response.ts
```

### 修正用
```powershell
# 週次サマリー再生成
npx tsx scripts/generate-optimized-weekly-summaries.ts

# 修正の動作確認
npm run dev
```

---

## 📊 進捗状況

- **Phase 1**: 0/8 完了
- **Phase 2**: 0/6 完了  
- **Phase 3**: 0/4 完了
- **Phase 4**: 0/4 完了
- **Phase 5**: 0/4 完了

**全体進捗**: 0/26 (0%)

---

## 🔗 関連ファイル

### 主要ファイル
- `lib/analytics/weekly-aggregation.ts` - 週計算・メトリクス計算
- `hooks/use-optimized-weekly-summaries.ts` - 期間選択変換
- `components/recruitment-dashboard.tsx` - UI表示ロジック
- `app/api/recruitment/optimized-weekly-summaries/route.ts` - API実装

### 確認対象データ
- Firestore: `applications` コレクション
- Firestore: `optimized_weekly_summaries` コレクション

---

## ⚠️ 重要な注意事項

1. **データの整合性**: 修正時はデータ整合性を保つ
2. **バックアップ**: 重要なデータは事前にバックアップ
3. **段階的実施**: 一度に全て修正せず段階的に実施
4. **ログ確認**: 各段階でログを確認して問題を早期発見

---

## 📝 作業ログ

### 実行日時: 
### 作業者: 
### 実行内容:
### 結果:
### 次のアクション:

---

*最終更新: 2025年1月19日* 