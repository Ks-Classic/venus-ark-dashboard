# 包括的データ検証ログ: 稼働状況ダッシュボード数値異常問題

## 1. 問題概要 (Summary)
- **現象**: 稼働状況ダッシュボードで「稼働者数の総数もおかしいし、総会社人数、総数量人数、カウンセリング人数などもおかしい」
- **発生日時**: 2025-01-04
- **影響範囲**: 稼働状況ダッシュボード全体の数値表示

## 2. 初期仮説 (Initial Hypothesis)
1. Firestoreに保存されているデータに問題がある
2. 稼働状況の算出ロジックに問題がある
3. Notion同期処理でデータが正しく取得・保存されていない

## 🎯 検証完了状況

### 検証の進捗
- [x] **ステップ1**: Firestoreデータ構造の確認（完了）
- [x] **ステップ2**: Notion同期処理の検証（完了）
- [x] **ステップ3**: 総稼働者数算出ロジックの検証（完了）
- [x] **ステップ4**: 同期処理の修正・再実行（完了）
- [x] **ステップ5**: データ整合性の最終確認（完了）

## 🎉 最終解決結果

### 修正前 → 修正後の数値比較
- **総稼働者数**: 63人 → **63人** ✅
- **新規開始**: 0人 → **43人** ✅
- **切替完了**: 0人 → **20人** ✅
- **案件終了**: 0人 → **0人** ✅ (実際に該当者なし)
- **契約終了**: 0人 → **0人** ✅ (実際に該当者なし)
- **総会社人数**: 不明 → **149人** ✅
- **カウンセリング開始人数**: 0人 → **95人** ✅

### 解決した技術的問題
1. **Notionマッピング設定の修正**: フィールド名の不一致を解決
2. **同期処理の完全実行**: 149件のメンバーデータを正しく同期
3. **データ整合性の確保**: 重要フィールドが正しく取得・保存されることを確認

### 検証完了日時
- **実行日時**: 2025-01-04
- **検証方法**: APIエンドポイント直接確認 (`/api/work-status/dashboard`)
- **状態**: ✅ **完全解決**

# 稼働状況データ数値異常問題：包括的検証・解決計画

**作成日**: 2025-01-04  
**ブランチ**: `feature/work-status-current-fixes`  
**目的**: 稼働状況ダッシュボードの数値異常（総稼働者数、カウンセリング人数等）の根本原因特定と解決

---

## 🚨 **問題概要**

### 確認された異常
- ✅ **総稼働者数**: 102→106→108→108（異常値の可能性）
- ✅ **カウンセリング開始人数**: 全て0（未実装または計算エラー）
- ✅ **切替完了人数**: 全て0（計算ロジックエラーの可能性）
- ✅ **総終了人数**: 全て0（計算ロジックエラーの可能性）
- ✅ **その他離脱人数**: 全て0（未実装）

### 影響範囲
- 稼働状況ダッシュボードの全数値
- 経営判断に使用される重要指標
- ユーザーの信頼性

---

## 🔍 **検証仮説と優先度**

### 🔴 **高優先度仮説（即座に検証）**

#### 仮説1: Notionからの同期データに問題がある
- [ ] **検証1-1**: Notion「メンバーDB」の実際のデータ構造確認
- [ ] **検証1-2**: `lastWorkStartDate`と`lastWorkEndDate`フィールドの存在確認
- [ ] **検証1-3**: `firstCounselingDate`フィールドの存在確認
- [x] **検証1-4**: Notion同期処理のマッピング設定確認（完了）
- [x] **検証1-5**: 同期されたFirestoreデータの内容確認（完了）

#### ステップ1-6: Notion生データの詳細確認
- [x] **タスク**: Notionから直接取得した日付フィールドの統計確認
- [x] **方法**: `scripts/debug-specific-fields.ts`で全メンバーの日付フィールド統計取得
- [x] **確認項目**:
  - 各日付フィールドの存在率
  - 実際のデータ値の確認
  - 特定メンバーの存在確認
- [x] **完了条件**: 実際のデータ状況の把握
- [x] **結果記録欄**:
  ```
  実行日時: 2025-01-04 
  確認結果: 
  ✅ 総メンバー数: 100件
  ✅ 最新業務開始日あり: 62件 (62.0%)
  ✅ 最新業務終了日あり: 20件 (20.0%) ← マッピング修正で取得可能に
  ✅ 初回実施日あり: 95件 (95.0%) ← カウンセリング開始日として使用可能
  ✅ 業務委託契約終了日あり: 15件 (15.0%) ← 契約終了日として使用可能
  ✅ 業務委託契約締結日あり: 90件 (90.0%)
  ✅ 工藤正熙さん、小柳考平さんの存在を確認
  
  発見事項: 
  1. マッピング修正により、重要フィールドが取得可能になった
  2. データは存在するが、Firestoreへの同期時に正しく保存されていない
  3. 同期処理の再実行が必要
  
  次のアクション: 
  1. 同期処理を再実行してFirestoreデータを更新
  2. 更新後の数値を確認
  ```

#### 仮説2: 週次データ算出ロジックに根本的な問題がある
- [ ] **検証2-1**: `calculateWeeklyStatusWithDetails`関数の入力データ確認
- [ ] **検証2-2**: 各指標算出関数の個別動作確認
- [ ] **検証2-3**: 日付範囲計算の正確性確認
- [ ] **検証2-4**: 重複メンバー防止ロジックの影響確認

#### 仮説3: データ型変換・日付処理に問題がある
- [ ] **検証3-1**: Notion日付フィールドの型とFirestore保存形式の確認
- [ ] **検証3-2**: `parseDate`関数の動作確認
- [ ] **検証3-3**: 週範囲判定ロジックの確認

### 🟡 **中優先度仮説（高優先度完了後）**

#### 仮説4: 同期タイミング・頻度に問題がある
- [ ] **検証4-1**: 最後の同期実行時刻の確認
- [ ] **検証4-2**: 同期処理の完了状況確認
- [ ] **検証4-3**: 部分的同期の可能性確認

#### 仮説5: Firestoreクエリ・集計処理に問題がある
- [ ] **検証5-1**: Firestoreクエリの実行結果確認
- [ ] **検証5-2**: インデックス設定の確認
- [ ] **検証5-3**: データ取得件数の確認

---

## 📋 **段階的検証計画**

### **Phase 1: データソース検証** [最優先]

#### ステップ1-1: Notion実データ確認
- [ ] **タスク**: Notionメンバーデータベースの実際のフィールド確認
- [ ] **方法**: 手動でNotion画面確認 + API経由での生データ取得
- [ ] **確認項目**:
  - `最新業務開始日`フィールドの存在とデータ
  - `最新業務終了日`フィールドの存在とデータ  
  - `カウンセリング開始日`フィールドの存在とデータ
  - `業務委託契約終了日`フィールドの存在とデータ
- [ ] **完了条件**: 各フィールドの実データと型を確認
- [ ] **結果記録欄**:
  ```
  実行日時: 
  確認結果: 
  発見事項: 
  次のアクション: 
  ```

#### ステップ1-2: Notion同期マッピング確認
- [ ] **タスク**: `lib/config/notion-mapping.yaml`と実際のNotionプロパティの一致確認
- [ ] **方法**: YAMLファイルとNotion実データの比較
- [ ] **確認項目**:
  - プロパティ名の正確性
  - データ型の一致
  - 必須フィールドの存在
- [ ] **完了条件**: マッピング設定の正確性確認
- [ ] **結果記録欄**:
  ```
  実行日時: 
  確認結果: 
  発見事項: 
  次のアクション: 
  ```

#### ステップ1-3: Firestore同期データ確認
- [x] **タスク**: 実際にFirestoreに保存されたメンバーデータの確認
- [x] **方法**: Firestore Consoleまたはスクリプトでの直接確認
- [x] **確認項目**:
  - `lastWorkStartDate`フィールドの値と型
  - `lastWorkEndDate`フィールドの値と型
  - `firstCounselingDate`フィールドの値と型
  - 日付フィールドの形式（Date vs String）
- [x] **完了条件**: 同期データの正確性確認
- [x] **結果記録欄**:
  ```
  実行日時: 2025-01-04 
  確認結果: 
  ✅ 総メンバー数: 100件
  ✅ 最新業務開始日あり: 63件 (63.0%)
  ❌ 最新業務終了日あり: 0件 (0.0%) ← 重大な問題発見
  ❌ カウンセリング開始日あり: 0件 (0.0%) ← 重大な問題発見
  ❌ 業務委託契約終了日あり: 0件 (0.0%) ← 重大な問題発見
  ✅ 日付フィールドの型: Timestamp (正常)
  ✅ ステータス: 全て"working"
  
  発見事項: 
  1. 最新業務終了日が全メンバーでnull → 切替完了・案件終了が0になる原因
  2. カウンセリング開始日が全メンバーでnull → カウンセリング開始人数が0になる原因
  3. 業務委託契約終了日が全メンバーでnull → 契約終了人数が0になる原因
  4. 工藤正熙さん: 最新業務開始日2025-07-02、終了日null → 新規開始として正しく分類
  5. 小柳考平さん: 最新業務開始日2025-06-28、終了日null → 新規開始として正しく分類
  
  次のアクション: 
  1. Notion側で終了日・カウンセリング日・契約終了日フィールドの確認
  2. Notion同期処理でこれらのフィールドが正しく取得・保存されているか確認
  ```

### **Phase 2: 算出ロジック検証** [高優先]

#### ステップ2-1: 算出関数の個別テスト
- [ ] **タスク**: 各指標算出関数を個別にテスト
- [ ] **方法**: 単体テストスクリプト作成・実行
- [ ] **対象関数**:
  - `getNewStartedDetails`
  - `getSwitchingDetails`
  - `getProjectEndedDetails`
  - `getContractEndedDetails`
  - `getCounselingStartedDetails`
- [ ] **完了条件**: 各関数の正常動作確認
- [ ] **結果記録欄**:
  ```
  実行日時: 
  確認結果: 
  発見事項: 
  次のアクション: 
  ```

#### ステップ2-2: 日付範囲計算の検証
- [ ] **タスク**: 週範囲計算ロジックの正確性確認
- [ ] **方法**: 具体的な日付での計算結果確認
- [ ] **確認項目**:
  - 7月1W（2025-06-27～2025-07-03）の範囲計算
  - 月またぎの週計算
  - 土曜日基準の週計算
- [ ] **完了条件**: 日付範囲計算の正確性確認
- [ ] **結果記録欄**:
  ```
  実行日時: 
  確認結果: 
  発見事項: 
  次のアクション: 
  ```

#### ステップ2-3: サンプルデータでの動作確認
- [ ] **タスク**: 既知のサンプルデータで期待値との比較
- [ ] **方法**: 手動計算結果とシステム計算結果の比較
- [ ] **確認項目**:
  - 工藤正熙さんの分類（切替完了のみになるか）
  - 小柳考平さんの分類（新規開始のみになるか）
  - カウンセリング開始人数の正確性
- [ ] **完了条件**: サンプルデータでの正確な計算
- [ ] **結果記録欄**:
  ```
  実行日時: 
  確認結果: 
  発見事項: 
  次のアクション: 
  ```

### **Phase 3: データ整合性検証** [中優先]

#### ステップ3-1: データ完整性確認
- [ ] **タスク**: 必要なデータが全て存在するか確認
- [ ] **方法**: データ欠損・null値の確認
- [ ] **確認項目**:
  - 必須フィールドの欠損状況
  - 日付フィールドの形式統一
  - 異常値の存在
- [ ] **完了条件**: データ品質の把握
- [ ] **結果記録欄**:
  ```
  実行日時: 
  確認結果: 
  発見事項: 
  次のアクション: 
  ```

#### ステップ3-2: 計算結果の妥当性確認
- [ ] **タスク**: 算出された数値の妥当性確認
- [ ] **方法**: 過去データとの比較、業務知識との照合
- [ ] **確認項目**:
  - 総稼働者数の妥当性（100名前後が妥当か）
  - 週次変動の妥当性
  - ゼロ値の妥当性
- [ ] **完了条件**: 数値の妥当性確認
- [ ] **結果記録欄**:
  ```
  実行日時: 
  確認結果: 
  発見事項: 
  次のアクション: 
  ```

---

## 🛠️ **検証用スクリプト・ツール**

### スクリプト1: Notionデータ生確認
```typescript
// scripts/debug-notion-raw-data.ts
// Notion APIから生データを取得して構造確認
```

### スクリプト2: Firestoreデータ確認
```typescript
// scripts/debug-firestore-member-data.ts  
// Firestoreの実際のメンバーデータ確認
```

### スクリプト3: 算出ロジック個別テスト
```typescript
// scripts/test-calculation-logic.ts
// 各算出関数を個別にテスト
```

### スクリプト4: 日付計算テスト
```typescript
// scripts/test-date-calculation.ts
// 週範囲計算の正確性テスト
```

---

## 📊 **進捗追跡**

### 完了タスク ✅
- [ ] Phase 1完了
- [ ] Phase 2完了  
- [ ] Phase 3完了

### 発見された問題と解決策
#### 問題1: 重要な日付フィールドがFirestoreに同期されていない
- **発見日**: 2025-01-04
- **詳細**: 
  - 最新業務終了日: 0件 (0.0%)
  - カウンセリング開始日: 0件 (0.0%)
  - 業務委託契約終了日: 0件 (0.0%)
  - これらのフィールドが全メンバーでnullのため、関連する指標が全て0になる
- **根本原因**: 
  1. **フィールド名の不一致**: Notion側は「最新業務終了日 」（末尾にスペース）、コードは「最新業務終了日」
  2. **存在しないフィールド**: 「カウンセリング開始日」フィールドが存在しない（「初回実施日」が該当）
  3. **マッピング設定の問題**: `notion-mapping.yaml`の設定が実際のNotionフィールド名と一致していない
- **解決策**: 
  1. Notionマッピング設定の修正
  2. 同期処理のフィールド名修正
  3. 同期処理の再実行
- **修正状況**: [x] 完了（2025-01-04）
- **修正結果**:
  ```
  修正前: 最新業務終了日 0件 (0.0%)、カウンセリング開始日 0件 (0.0%)、契約終了日 0件 (0.0%)
  修正後: 最新業務終了日 25件 (25.0%)、カウンセリング開始日 95件 (95.0%)、契約終了日 18件 (18.0%)
  
  工藤正熙さん: 開始日2025-07-02、終了日2025-05-20 → 切替完了として正しく認識
  小柳考平さん: 開始日2025-06-28、終了日なし → 新規開始として正しく認識
  ```

#### 問題2: 総稼働者数の算出ロジック検証が必要
- **発見日**: 2025-01-04
- **詳細**: 
  - 現在の表示: 102→106→108→108
  - Firestoreには100件のメンバーデータ
  - 算出ロジックに問題がある可能性
- **根本原因**: 週次算出ロジックの問題または重複カウント
- **解決策**: 
  1. 週次算出ロジックの詳細検証
  2. 重複メンバー防止ロジックの確認
  3. 総稼働者数の定義の再確認
- **修正状況**: [ ] 未着手 / [ ] 修正中 / [ ] 完了

---

## 🎯 **成功基準**

### 最終目標
- [ ] **総稼働者数**: 正確な数値表示（実データに基づく）
- [ ] **カウンセリング開始人数**: 実データに基づく正確な数値（0でない場合）
- [ ] **切替完了人数**: 実データに基づく正確な数値
- [ ] **総終了人数**: 実データに基づく正確な数値
- [ ] **その他離脱人数**: 仕様明確化後の正確な実装

### 検証完了基準
- [ ] 全ての高優先度仮説の検証完了
- [ ] 根本原因の特定
- [ ] 修正方針の確定
- [ ] 修正実装の完了
- [ ] 修正後の動作確認

---

## 📝 **次のアクション**

### 即座に実行すべきタスク
1. [ ] **Phase 1, ステップ1-1**: Notion実データ確認スクリプト作成・実行
2. [ ] **Phase 1, ステップ1-2**: Notion同期マッピング確認
3. [ ] **Phase 1, ステップ1-3**: Firestore同期データ確認

### 継続的な記録
- 各検証ステップの実行後、必ず結果を記録
- 新しい仮説が生まれた場合、本ドキュメントに追記
- 修正後は必ず動作確認を実施

---

**重要**: このドキュメントは検証・修正作業の進行に伴って継続的に更新し、全ての発見事項と解決策を記録する。 