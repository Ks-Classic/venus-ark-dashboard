# UI/UX改善: 稼働状況ダッシュボード最適化

## 1. エラー概要 (Summary)
- **現象**: ユーザーが求める機能と現在の実装にギャップがある
- **影響範囲**: 稼働状況タブ全体のユーザビリティ
- **優先度**: High

## 2. 改善要求 (Requirements)
1. **メンバーステータス詳細の削除**: 不要な機能を削除
2. **用語定義の表示方法変更**: ブロック表示からボタン式ポップアップに変更
3. **主要項目詳細の簡素化**: 選択期間のメンバー表示のみに絞る
4. **ステータス名の統一**: Notionで使用している用語に統一
5. **将来見込みデータの修正**: 数字データ型が正しく反映されていない問題の解決

## 3. 開発計画 (Development Plan)

### Phase 1: 現在の稼働状況 改善 🎯
- [x] **メンバーステータス詳細削除**
  - [x] `components/work-status/member-status-cards.tsx` 削除
  - [x] `detailed-status-table.tsx` からの参照削除（参照なし確認済み）
  - [x] `work-status-dashboard.tsx` からの参照削除とコンポーネント使用箇所削除
  - [x] 不要なAPI呼び出し削除（不要な呼び出しなし確認済み）

- [x] **用語定義UI改善**
  - [x] ブロック表示を削除
  - [x] ボタン式ポップアップ実装（Popover + HelpCircleアイコン）
  - [x] 用語定義コンテンツの整理

- [ ] **主要項目詳細の簡素化**
  - [ ] 選択期間のメンバー表示機能のみ残す
  - [ ] 不要な複雑な表示ロジック削除
  - [ ] UIの簡素化

- [x] **Notionステータス名の調査・適用**
  - [x] Notionで実際に使用されているステータス名を調査（`working`, `contract_ended`, `work_ended`）
  - [x] UI表示名の統一（既に統一済み確認）
  - [ ] `03_data_definition.md` のステータス定義更新

### Phase 2: 稼働者将来見込み データ修正 🔧
- [x] **データ型問題の調査**
  - [x] 前月・当月・翌月のデータ定義確認
  - [x] 数字データ型が反映されない原因特定（実績データ混入）
  - [x] `future-projection` APIの詳細デバッグ

- [x] **データフロー修正**
  - [x] 計算ロジックの全面修正（実績vs予定の適切な分離）
  - [x] 当月は実績+予定、翌月以降は予定のみの実装
  - [x] 案件切替の計算ロジック修正（過去履歴除外）

- [x] **UI表示の最適化**
  - [x] 月ラベルとAPIデータの不一致修正
  - [x] データが0件の場合の適切な表示
  - [x] エラーハンドリングの改善

## 4. 調査ログ (Investigation Log)

- [ ] **仮説1**: メンバーステータス詳細が不要
  - **検証方法**: ユーザー要望の確認、現在の利用状況分析
  - **結果**: ユーザーから明確に「いらない」との指摘
  - **考察**: 削除対象として確定

- [x] **仮説2**: 将来見込みのデータ型問題
  - **検証方法**: APIレスポンスとFirestoreデータの比較、計算ロジックの確認
  - **結果**: 問題を特定 - 実績データが将来見込みとして計算されている
  - **考察**: 
    - 現在の計算ロジックが `firstWorkStartDate` と `lastWorkStartDate` の両方を見ているため、実績データも含んでしまう
    - 案件切替の計算で過去の履歴も将来予測として計算している
    - 定義を明確化：前月（実績のみ）、当月（実績+予定）、翌月以降（予定のみ）

- [x] **仮説3**: UI表示とAPIデータの不一致
  - **検証方法**: curlでAPIレスポンス確認、フロントエンドコード分析
  - **結果**: 月ラベルが固定値（5月、6月、7月）でAPIデータ（6月、7月、8月）と不一致
  - **考察**: UIの月ラベルを動的生成に変更する必要がある

## 5. 実績・予定の詳細定義 (Data Definition)

### 5.1 基本概念
- **実績**: 既に発生した事実（過去の履歴データ）
- **予定**: 将来発生する見込み（未来の計画データ）

### 5.2 月別データ定義
- **前月**: 完全に過去の実績のみ（将来見込み対象外）
- **当月**: 実績（月初～現在）+ 予定（現在～月末）を含める
- **翌月以降**: 予定のみ（将来の計画データ）

### 5.3 フィールド別の実績・予定判定基準

#### 5.3.1 新規開始
- **実績**: `firstWorkStartDate` が過去～現在の日付
- **予定**: `lastWorkStartDate` が現在～将来の日付
- **計算ロジック**:
  - 当月: `firstWorkStartDate` + `lastWorkStartDate` の両方を含める
  - 翌月以降: `lastWorkStartDate` の将来予定のみ

#### 5.3.2 案件切替
- **実績**: `workHistory` 配列内の過去の切替履歴
- **予定**: `workHistory` 配列内の将来の切替予定
- **計算ロジック**:
  - 過去の履歴（実績）は将来見込みから除外
  - 将来の切替予定のみを計算対象とする

#### 5.3.3 案件終了・契約終了
- **実績**: 過去に終了したメンバーの履歴
- **予定**: 将来終了予定のメンバー
- **計算ロジック**:
  - `workEndDate`, `contractEndDate` が将来日付のメンバーのみ対象
  - 過去の終了履歴は除外

### 5.4 具体的な判定例（2025年6月基準）

#### 6月のデータ（当月）
- **新規開始 55名**: 
  - 実績: 6月1日～現在まで開始したメンバー
  - 予定: 現在～6月30日まで開始予定のメンバー
- **案件切替 0名**: 
  - 過去の切替履歴は除外（実績として計算済み）
  - 6月中の切替予定は含める

#### 7月のデータ（翌月）
- **新規開始 1名**: `lastWorkStartDate` が2025年7月のメンバーのみ
- **案件切替 1名**: `workHistory` で7月に切替予定のメンバーのみ

#### 8月のデータ（翌々月）
- **新規開始 0名**: `lastWorkStartDate` が2025年8月のメンバーなし
- **案件切替 0名**: `workHistory` で8月に切替予定のメンバーなし

### 5.5 データ整合性の確認ポイント
1. **過去データの除外**: 実績データが将来見込みに混入していないか
2. **重複計算の防止**: 同一メンバーが複数月で重複計算されていないか
3. **日付境界の正確性**: 月境界での日付判定が正確に行われているか
4. **ステータス整合性**: メンバーのステータス（`working`, `contract_ended`, `work_ended`）と計算結果の整合性

### 5.6 デバッグログから確認された実装状況
- **修正前**: 実績データが将来見込みに混入（6月新規=49, 切替=49）
- **修正後**: 実績と予定を適切に分離（6月新規=55, 切替=0）
- **翌月以降**: 予定のみの正確な計算（7月新規=1, 切替=1）

## 6. 完了基準 (Definition of Done)
- [x] メンバーステータス詳細が完全に削除されている
- [x] 用語定義がボタン式ポップアップで表示される
- [ ] 主要項目詳細が選択期間のメンバー表示のみになっている
- [x] ステータス名がNotionの用語と統一されている
- [x] 将来見込みで前月・当月・翌月のデータが正しく表示される
- [x] 数字データ型の問題が解決されている
- [x] UI表示の月ラベルとAPIデータが一致している

## 7. 修正完了項目の詳細

### Phase 2完了: 将来見込みデータ修正
**修正結果:**
- **6月新規開始**: 49名 → 55名（実績+予定を正しく含める）
- **6月案件切替**: 49名 → 0名（過去実績を除外）
- **7月新規開始**: 0名 → 1名（将来予定のみ）
- **7月案件切替**: 0名 → 1名（将来切替予定）

**実装した計算ロジック:**
1. 当月（6月）: `firstWorkStartDate` + `lastWorkStartDate` の実績+予定
2. 翌月以降: `lastWorkStartDate` の将来予定のみ
3. 案件切替: 過去履歴を除外し、将来の切替予定のみ計算

### UI表示修正完了: 月ラベル動的生成
**問題:**
- UIの月ラベル: `['2025年5月', '2025年6月', '2025年7月']` (固定)
- APIデータ: `[6月データ, 7月データ, 8月データ]` (実際のレスポンス)
- 結果: 5月列に6月データが表示される不整合

**修正内容:**
- 月ラベルを `futureProjectionData.map(data => data.year年data.month月)` で動的生成
- テーブルヘッダーとメンバー詳細の両方で一致するよう修正

## 8. 次のアクション
- [ ] 主要項目詳細の簡素化（Phase 1残タスク） 