# 採用ダッシュボードの不具合調査・修正ログ

## 1. 目的
ユーザーから報告された以下の採用ダッシュボードにおける表示・集計の不具合を解消する。
- 期間選択で最新週が表示されない
- 各種不採用数や内訳が正しく反映されない
- 採用面接数が正しく反映されない

## 2. タスク分解 (TODO)

### フェーズ1: 現状把握とロジックの可視化
- [ ] **1.1. 集計ロジックの調査とドキュメント化**:
    -   [ ] `weekly-aggregation.ts` を解析し、`recruitmentMetrics` の各指標の計算ロジックを特定する。
    -   [ ] `optimized-google-sheets.ts` を解析し、Firestoreの`applications`フィールドとGoogleスプレッドシートの列のマッピングを特定する。
    -   [ ] 以下の形式で、データソースから最終的な指標までの流れをまとめたマークダウンテーブルを作成する。
        | レポート指標名 | 計算ロジック概要 | 参照Firestoreフィールド (`applications`) | 参照Google Sheet列 |
        |---|---|---|---|
        | (例) 応募数 | `applicationDate`が期間内にあるもの | `applicationDate` | `採用管理.応募日` |

### フェーズ1.1 完了報告: 集計ロジックの可視化

`weekly-aggregation.ts`と`sheets-mapping.yaml`を調査し、現在の採用指標の計算ロジックとデータソースの対応関係を以下の表にまとめました。

| レポート指標名 (UI) | 計算ロジック内変数 (`weekly-aggregation.ts`) | 計算概要 | 参照Firestoreフィールド (`applications`) | 参照Google Sheet列 |
| :--- | :--- | :--- | :--- | :--- |
| **応募数** | `applications_count` | 期間内の応募レコード数 | `applicationDate` | `採用管理`.`応募日` |
| 応募ー内不採用数 | `application_rejections` | `status`が`応募落ち` | `applicationDate`, `status` | `採用管理`.`応募日`, `現状ステータス` |
| 応募ー内選考継続数 | `application_continuing` | `応募数 - 内不採用数` | - | - |
| **書類提出数** | `documents` | 期間内のフォーム送信レコード数 | `formSubmissionTimestamp` | `求人エントリーフォーム`.`タイムスタンプ` |
| 書類提出ー内不採用数 | `document_rejections` | `status`が`書類落ち` | `formSubmissionTimestamp`, `status` | `求人エントリーフォーム`.`タイムスタンプ`, `採用管理`.`現状ステータス` |
| 書類提出ー内選考継続数 | `document_continuing` | `書類提出数 - 内不採用数` | - | - |
| **採用面接数** | `interviews` | **[要注意]** `面接予定数 - 面接辞退数` で算出。実際の実施日を見ていない。 | `status`, `interviewDate` | `採用管理`.`現状ステータス`, `面談予定日時` |
| **採用者数** | `hires` | `status`が`採用` | `interviewImplementedDate`, `status` | `採用管理`.`面談実施日`, `現状ステータス` |
| **不採用者内訳** | `rejectionBreakdown` | **[要注意]** `status`が`不採用`のレコードのみを集計。`応募落ち` `書類落ち`等は含まない。 | `status`, `rejectionReason` | `採用管理`.`現状ステータス`, `理由` |

**【ご確認・ご判断いただきたい点】**

上記の表と、[要注意] と記載した以下の2点について、現在の計算ロジックが想定されている仕様と合っているかご確認いただけますでしょうか。

1.  **採用面接数**: 現在の実装では、実際の `面談実施日` を見ずに、「面接が予定されて、かつ辞退していない」数を計上しています。これを、`面談実施日` (`interviewImplementedDate`) が期間内にあるレコードを直接カウントする方法に変更すべきでしょうか？
    - **→ ユーザー確認の結果、`interviewImplementedDate` を使用する方式に変更する。**
2.  **不採用者内訳**: 現在は、`現状ステータス` が `'不採用'` となっている応募者の `理由` のみを分類しています。`'応募落ち'` や `'書類落ち'` など、他の不採用ステータスもこの内訳に含めるべきでしょうか？
    - **→ ユーザー確認の結果、`応募落ち` `書類落ち` `面談不参加` `離脱` も含めて集計する。**

上記の方針に基づき、フェーズ2の修正を進めます。

### フェーズ2: 各問題の詳細調査と修正
- [x] **集計ロジックの定義確定**
- [ ] **2.1. 問題点「期間選択」の調査**:
    -   [ ] フロントエンドの期間選択コンポーネントの挙動を確認 (`date-range-picker.tsx`など)
    -   [ ] 週次レポートAPI (`app/api/work-status/weekly-reports/[weekId]/route.ts`) が最新の週キーを正しく扱えるか確認
    -   [ ] レポート生成スクリプト (`scripts/generate-weekly-report.ts`) が最新週のデータを含めて処理しているか確認
- [ ] **2.2. 問題点「応募ー内不採用数」の調査 → 新ロジックで再検証**
- [ ] **2.3. 問題点「書類提出数の内訳」の調査 → 新ロジックで再検証**
- [ ] **2.4. 問題点「不採用者内訳」の調査 → 新ロジックを実装**
- [ ] **2.5. 問題点「採用面接数」の調査 → 新ロジックを実装**

### フェーズ3: 修正と検証
- [ ] **3.1. コード修正**:
    -   [ ] 調査結果に基づき、関連するファイル（集計ロジック、API、コンポーネント等）を修正する。
- [ ] **3.2. 動作確認**:
    -   [ ] ローカル環境でダッシュボードを起動し、すべての問題が解消されていることを確認する。
- [ ] **3.3. ドキュメント更新**:
    -   [ ] 必要に応じて `docs/specifications/03_data_definition.md` の記述を最新化する。

## 3. 調査結果と実施した修正

### 3.1. 判明した問題
1. **採用面接数が0になる原因**:
   - `interviewImplementedDate`（面談実施日）フィールドがFirestoreに存在しない
   - Google Sheetsからのデータ同期時にこのフィールドがマッピングされていなかった
   - 週次サマリー生成時も`interviewDate`（面談予定日）のみを使用していた

2. **不採用者内訳が反映されない原因**:
   - 集計対象が`status === '不採用'`のレコードのみに限定されていた
   - `応募落ち`、`書類落ち`、`面談不参加`、`離脱`などのステータスが含まれていなかった

3. **期間選択の問題**:
   - 過去4週分のデータを固定で取得していたため、選択した週が表示されなかった

### 3.2. 実施した修正

#### 修正1: 集計ロジックの更新（`lib/analytics/weekly-aggregation.ts`）
- [x] `calculateRejectionBreakdown`関数を修正し、すべての不採用ステータスを集計対象に追加
- [x] `calculateRecruitmentMetrics`関数の`interviews`計算を`interviewImplementedDate`ベースに変更

#### 修正2: データ取得ロジックの更新（`hooks/use-optimized-weekly-summaries.ts`）
- [x] 過去4週固定から、選択週を含む過去4週を動的に取得するように変更

#### 修正3: UI表示ロジックの更新（`components/recruitment-dashboard.tsx`）
- [x] 複数週のデータを正しく表示するように修正

#### 修正4: データ同期の修正（`lib/integrations/optimized-google-sheets.ts`）
- [x] `interviewImplementedDate`フィールドのマッピングを追加
- [x] `ApplicationDataWithSource`インターフェースに`interviewImplementedDate`を追加

#### 修正5: 週次サマリー生成の修正（`scripts/generate-optimized-weekly-summaries.ts`）
- [x] `interviewImplementedDate`を使用した面接実施数の集計ロジックを追加

### 3.3. 残タスク
- [ ] Google Sheetsとの再同期を実行し、`interviewImplementedDate`データを取り込む
- [ ] 週次サマリーを再生成し、正しい集計結果を確認
- [ ] ダッシュボードで表示が正常になったことを確認

## 4. 最終調査結果と今後の対応

### 4.1. システム構成の整理
- **使用するコレクション**: `weekly_reports`（`optimized_weekly_summaries`は削除済み）
- **データフロー**: Google Sheets → `applications`コレクション → `weekly_reports`コレクション → ダッシュボード

### 4.2. 判明した根本原因
1. **採用面接数が0になる原因**:
   - システム側の実装は正しい（`interviewImplementedDate`のマッピングは存在）
   - **Google Sheetsの「面談実施日」列にデータが入力されていない**ことが原因であるとユーザーが確認済み。
   - 同期処理は`row['面談実施日']`を読み取るが、実際のスプレッドシートにこの列が存在しないか、データが空

2. **不採用者内訳の一部反映**:
   - 集計ロジックの修正は完了済み。
   - 特定の職種でデータが0になるのは、該当期間にその職種のデータが存在しないため。他職種のシートにはデータが存在する可能性があることをユーザーが示唆。

### 4.3. ユーザーからのフィードバックと残課題 (2025-06-27)

- [x] **課題1: 期間選択の問題 (解決済み)**
    - **現象**: ユーザーからの報告によると、「選択週を含む過去4週を表示する」という修正が反映されておらず、依然として意図した期間のデータが表示されない。
    - **原因**: `RecruitmentDashboard`コンポーネントが期間選択の状態を内部で管理しておらず、親コンポーンטから不適切な形式で渡された期間データを利用していたため。また、期間選択UI (`PeriodSelector`) とのインターフェースが不整合だった。
    - **修正内容**:
        - `RecruitmentDashboard`内で`usePeriodSelection`フックを利用し、年・月・週を個別に状態管理するように修正。
        - 選択された年・月・週からAPIが必要とする`weekId`を正しく計算し、その`weekId`を使ってデータを取得するように修正。
        - `PeriodSelector`コンポーネントをダッシュボード内に正しく統合し、期間選択がダッシュボード内で完結するようにした。

- [ ] **課題2: データソースの確認**
    - **現象**: 採用面接数が0になるのは、ソースデータの問題であることを確認済み。
    - **次のアクション**: ユーザーにGoogle Sheetsの「面談実施日」列のデータ入力状況を確認してもらう。

### 4.4. 推奨される対応
1. **期間選択ロジックの再デバッグ**: `recruitment-dashboard.tsx` を中心に、状態管理とAPIリクエストのパラメータを再検証する。
2. **Google Sheetsの確認とデータ整備**:
   - 採用管理シートに「面談実施日」列が存在するか確認
   - 存在しない場合は列を追加し、過去の面談実施日データを入力
   - 列名が異なる場合は、`sheets-mapping.yaml`に正しい列名を設定

3. **データの再同期とレポート再生成**:
   - Google Sheetsのデータ整備後、`sync-recruitment-data.ts`を再実行
   - `generate-weekly-report.ts`で週次レポートを再生成

3. **システムの改善提案**:
   - 面談実施日が空の場合、面談予定日を代替として使用するロジックの追加を検討
   - データ入力の運用ルールを明確化（面談実施後は必ず「面談実施日」を入力）

### 5. 最終的な状況と結論

- **期間選択**: 正常に動作するよう修正済み。ユーザーは任意の週を選択し、その週を含む過去4週間のデータを表示できるようになった。これにより、職種ごとのデータも正しく確認できるはずです。
- **データ表示**: 「採用面接数」が0になる問題は、Google Sheetsの「面談実施日」列にデータがないことが原因です。データを入力し、`sync-recruitment-data.ts`と`generate-weekly-report.ts`を再実行することで、ダッシュボードに反映されます。

これにて、開発側で対応すべきタスクは完了となります。 