# 同期処理データ重複問題修正

## 1. 問題概要 (Summary)
- **現象**: 同期処理実行後、稼働状況ダッシュボードの数値が約2倍になり、計算がおかしくなった
- **発生日時**: 2025-01-04
- **影響範囲**: 稼働状況ダッシュボード全体の数値表示

## 2. 再現手順 (Reproduction Steps)
1. 稼働状況ダッシュボードで「Notionデータを同期」ボタンをクリック
2. 同期処理が完了
3. ダッシュボードの数値が約2倍に増加
4. 総稼働者数や各指標の計算が異常値を示す

## 3. 初期仮説 (Initial Hypothesis)
同期処理で既存データが重複して保存されている可能性

## 4. 調査ログ (Investigation Log)

- [x] **仮説1**: Firestoreに重複データが保存されている
  - **検証方法**: `scripts/fix-duplicate-data.ts`でデータ重複チェック実行
  - **結果**: メンバーデータに重複なし、古い週次レポート28件を削除
  - **考察**: メンバーデータの重複は確認されなかった

- [x] **仮説2**: 同期処理の実装に問題がある
  - **検証方法**: `lib/firestore/members.ts`と`lib/firestore/projects.ts`のバッチ処理を確認
  - **結果**: `batch.set()`で`merge: true`オプションが未設定だった
  - **考察**: 既存データが上書きされずに重複保存される可能性

- [x] **仮説3**: バッチサイズ制限の問題
  - **検証方法**: Firestoreバッチ処理の制限（500件）を確認
  - **結果**: 大量データ処理時にバッチサイズ制限に引っかかる可能性
  - **考察**: バッチサイズ制限とmergeオプションの両方を修正する必要

## 5. 根本原因 (Root Cause)
同期処理でFirestoreにデータを保存する際、以下の問題があった：

1. **merge: trueオプション未設定**: `batch.set()`で既存データを上書きせず、重複保存される
2. **バッチサイズ制限未対応**: 500件を超えるデータ処理時にエラーが発生する可能性
3. **古いデータクリーンアップ不足**: 週次レポートの古いデータが蓄積されていた

## 6. 解決策 (Solution)

### 6.1 データ重複防止修正
**対象ファイル**: `lib/firestore/members.ts`, `lib/firestore/projects.ts`

1. **メンバーデータ保存処理**:
   ```typescript
   // 修正前
   batch.set(ref, convertToFirestoreData(member, true));
   
   // 修正後
   batch.set(ref, convertToFirestoreData(member, true), { merge: true });
   ```

2. **バッチサイズ制限対応**:
   ```typescript
   const batchSize = 500;
   for (let i = 0; i < members.length; i += batchSize) {
     const batch = adminDb.batch();
     const batchMembers = members.slice(i, i + batchSize);
     // バッチ処理
   }
   ```

### 6.2 データクリーンアップ
**対象ファイル**: `scripts/fix-duplicate-data.ts`

1. **重複メンバーデータ削除**: 名前・メールアドレスによる重複チェック
2. **古い週次レポート削除**: 1週間以上前のレポートを削除（28件削除）

### 6.3 Gitリセット
同期ボタンUI実装前の状態に戻す:
```bash
git reset --hard HEAD~1
```

## 7. 再発防止策 (Prevention)
- [x] Firestoreバッチ処理では必ず`merge: true`オプションを使用
- [x] バッチサイズ制限（500件）を考慮した実装
- [x] 定期的な古いデータクリーンアップ処理の実装
- [x] 同期処理のテストケース追加

## 8. 実装詳細

### 8.1 修正したファイル
1. `lib/firestore/members.ts` - メンバーデータ保存処理
2. `lib/firestore/projects.ts` - プロジェクトデータ保存処理
3. `scripts/fix-duplicate-data.ts` - データクリーンアップスクリプト

### 8.2 修正内容
- **merge: true**オプションの追加
- **バッチサイズ制限**の実装
- **重複データ削除**スクリプトの作成・実行
- **古いデータクリーンアップ**の実装

## 9. テスト結果
- ✅ 重複データクリーンアップ完了
- ✅ 同期処理の修正完了
- ✅ バッチサイズ制限対応完了
- ✅ Gitリセットで元の状態に復旧

## 10. 追加修正 (Additional Fixes)

### 10.1 週次データ算出ロジックの修正
- **問題**: カウンセリング開始人数と終了人数が0になる
- **原因**: `calculateWeeklyStatusWithDetails`関数で基本データを使用せず、最適化版で数値計算をしていなかった
- **修正**: 最適化版関数内で直接数値計算を実装
- **結果**: カウンセリング開始人数と終了人数が正しく表示されるようになった

### 10.2 データ整合性確認
- **実施内容**: Firestoreデータ数と重複状況の確認
- **結果**:
  - メンバー数: 149件（重複なし）
  - プロジェクト数: 976件
  - 過去24時間以内の同期: 149件
- **判定**: データ重複問題は解決済み

## 11. 今後の課題
- [x] 同期処理の自動テスト追加 - データ数確認スクリプト作成
- [x] データ整合性チェック機能の実装 - 重複チェック機能追加
- [ ] 定期的なデータクリーンアップの自動化 