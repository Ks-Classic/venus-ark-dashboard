# 機能開発: 離職要因分析の高度化

## 1. 概要
ユーザーからのフィードバックに基づき、離職要因分析の精度を向上させる。
- **最寄り駅**: 単純な駅名ではなく、メンバーの自宅最寄り駅と案件勤務地の緯度経度から「通勤距離」を算出して分析に用いる。
- **職種**: 採用時の学習カテゴリではなく、実際の稼働職種（インバウンド/アウトバンド等）を基に分析する。

## 2. タスク分解 (Task Breakdown)

### Phase 1: データ基盤の強化

- [ ] **Notion同期スクリプト改修 (`lib/integrations/notion.ts` or `enhanced-notion-sync.ts`)**
    - [ ] メンバーDBから「最寄り駅の緯度・経度」を取得するロジックを追加
    - [ ] 案件DBから「勤務地の緯度・経度」を取得するロジックを追加
    - [ ] 案件DBから「実際の稼働職種」を取得するロジックを追加
- [ ] **型定義の更新**
    - [ ] `lib/types/member.ts` に `nearestStationCoords: { lat: number, lon: number }` (仮) を追加
    - [ ] `lib/types/project.ts` に `workLocationCoords: { lat: number, lon: number }` (仮) と `actualJobCategory: string` (仮) を追加
- [ ] **データ定義書の更新 (`docs/specifications/03_data_definition.md`)**
    - [ ] `members` と `projects` コレクションに新しいフィールドの定義を追記
- [ ] **データ同期の実行と確認**
    - [ ] 改修したスクリプトを実行し、Firestoreに新しいデータが正しく格納されることを確認

### Phase 2: 分析ロジックの高度化

- [ ] **分析ライブラリの改修 (`lib/analytics/work-status-aggregation.ts`等)**
    - [ ] 緯度経度から距離を計算するユーティリティ関数を実装 (例: `lib/utils/distance.ts`)
    - [ ] 稼働履歴と案件情報を紐付け、通勤距離を算出するロジックを追加
    - [ ] 分析のグルーピング軸を「採用時職種」から「実際の稼働職種」に置換
- [ ] **APIの改修 (`app/api/work-status/`)**
    - [ ] 高度化された分析結果を返すようにAPIレスポンスを修正
- [ ] **フロントエンドの修正 (`components/work-status/`)**
    - [ ] 新しい分析軸（通勤距離、実際の稼働職種）でデータを表示できるようUIを調整

### Phase 3: テストと検証

- [ ] **単体テストの作成・更新**
    - [ ] 距離計算ロジックのテスト
    - [ ] 新しい分析ロジックのテスト
- [ ] **UIテストの実施**
    - [ ] `docs/development_logs/UI_TEST_CHECKLIST.md` に基づく手動テスト
    - [ ] 分析結果が意図通りに表示されることを確認

## 3. 関連ドキュメント
- `docs/specifications/03_data_definition.md`
- `docs/specifications/06_environment_setup.md` 