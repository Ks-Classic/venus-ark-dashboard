# エラー調査ログ: 採用ダッシュボードで6月のデータが表示されない問題

## 1. エラー概要 (Summary)
- **現象**: 採用ダッシュボードで「6月3週」を選択しても実データが表示されない
- **発生日時**: 2025-01-27
- **影響範囲**: 採用ダッシュボードの週次データ表示機能全般

## 2. 再現手順 (Reproduction Steps)
1. ブラウザで採用ダッシュボードにアクセス
2. 期間選択で「6月3週」を選択
3. コンソールログを確認すると「ドキュメント 2025-06-W03 が見つかりません」と表示
4. 利用可能な週リストには2025年1月〜3月のデータ（2025-W01〜W10）のみ表示

## 3. 初期仮説 (Initial Hypothesis)
週キー形式の不一致が原因。UI側が`2025-06-W03`形式で検索しているが、データベースには`2025-W03`形式で保存されている可能性。

## 4. 調査ログ (Investigation Log)

### 4.1 現在の状況確認
- [x] **仮説1**: 週キー形式の不一致
  - **検証方法**: ログ分析とデータベース構造確認
  - **結果**: 
    - UI側: `2025-06-W03` (年-月-W週) 形式で検索
    - DB側: `2025-W01`〜`2025-W10` (年-W週) 形式で保存
    - 6月のデータが存在しない（利用可能なのは1月〜3月のみ）
  - **考察**: 週キー形式の不一致は確認できたが、そもそも6月のデータが存在しない

### 4.2 対応済み項目
- [x] **対応1**: 週キー変換ロジック追加
  - **実装内容**: `2025-06-W03` → `2025-W03` への自動変換ロジック
  - **場所**: `app/api/recruitment/optimized-weekly-summaries/route.ts`
  - **結果**: 実装完了、ただし6月データ自体が存在しないため効果確認不可

- [x] **対応2**: 詳細デバッグログ追加
  - **実装内容**: 2025年の実際のドキュメント一覧表示、データ内容確認
  - **結果**: 2025年のデータが1月〜3月（W01〜W10）までしか存在しないことが判明

### 4.3 対応完了項目
- [x] **仮説2**: 6月のデータが生成されていない
  - **検証方法**: データ生成スクリプトの実行履歴確認、6月データの再生成
  - **結果**: `npx tsx scripts/generate-optimized-weekly-summaries.ts`実行
    - 2025年の全週（W01〜W25）データ生成完了
    - 6月のデータは2025-W21〜W25として存在
  - **考察**: データ生成は成功、UI側の週計算ロジックに問題がある可能性

### 4.4 未解決の仮説

- [x] **仮説3**: UI側の週計算ロジックの問題
  - **検証方法**: 6月の週番号とISO週の対応を確認
  - **結果**: 
    - 6月3週 → `2025-06-W03` (UI側) vs `2025-W23` (実際のISO週)
    - 週キー変換ロジックが単純な月情報除去では不十分
  - **考察**: 月内週番号とISO週番号の変換が必要

### 4.5 解決済み項目
- [x] **週キー変換ロジック実装**
  - **実装内容**: 月内週番号 → ISO週番号変換関数
  - **場所**: `app/api/recruitment/optimized-weekly-summaries/route.ts` L14-46
  - **アルゴリズム**: 
    1. 月の1日を含む週の土曜日を特定
    2. 指定週の土曜日を計算
    3. その日のISO週番号を取得
  - **結果**: 2025-06-W03 → 2025-W24への変換が可能

### 4.6 新たな問題発見
- [x] **重大な問題**: 500 Internal Server Error
  - **現象**: UI側から `2025-06-W01`, `2025-06-W02`, `2025-06-W03` でリクエスト → 500エラー
  - **影響**: 週キー変換ロジック実装後もAPIが正常に動作していない
  - **結果**: フロントエンド側で「取得成功: 0週分のデータ」が表示
  - **考察**: 週キー変換ロジック内でエラーが発生している可能性

### 4.7 根本原因特定完了
- [x] **仮説4**: Firestoreインデックス不足による500エラー
  - **検証方法**: エラーログ詳細確認
  - **結果**: 
    - **根本原因発見**: `9 FAILED_PRECONDITION: The query requires an index`
    - **原因**: `.where('year', '==', 2025).orderBy('weekNumber')` クエリに必要な複合インデックスが存在しない
    - **エラー詳細**: `year` + `weekNumber` + `__name__` の複合インデックスが必要
  - **考察**: 週キー変換ロジックは正常、データベースアクセス時のインデックス不足が問題

### 4.8 データ状況確認済み
- [x] **データベース状況**: 
  - **利用可能データ**: 2025-W01〜W10のみ（1月〜3月）
  - **不足データ**: 6月のデータ（W21〜W25）が存在しない
  - **サンプルデータ**: 2001年、2022年の古いテストデータのみ
  - **問題**: データ生成スクリプト実行後も6月データが反映されていない

## 5. 次のアクション (Next Actions)
### 優先度: 最高（緊急）
1. **Firestoreインデックス作成**
   - [x] **500エラーの根本原因特定** → 完了（インデックス不足）
   - [x] **一時的な回避策実装** → 完了（orderByクエリを削除）
   - [ ] **Firestoreインデックスの作成**
     - 対象: `optimized_weekly_summaries` コレクション
     - フィールド: `year` (ascending) + `weekNumber` (ascending)
     - URL: https://console.firebase.google.com/v1/r/project/venus-ark-aix/firestore/indexes?create_composite=CmBwcm9qZWN0cy92ZW51cy1hcmstYWl4L2RhdGFiYXNlcy8oZGVmYXVsdCkvY29sbGVjdGlvbkdyb3Vwcy9vcHRpbWl6ZWRfd2Vla2x5X3N1bW1hcmllcy9pbmRleGVzL18QARoICgR5ZWFyEAEaDgoKd2Vla051bWJlchABGgwKCF9fbmFtZV9fEAE
   - [ ] **インデックス作成後の動作確認**

### 優先度: 高
2. **データ不整合の解決**
   - [x] **データ生成スクリプト実行** → 完了（しかし6月データが反映されていない）
   - [ ] **データ生成結果の検証**
     - 生成されたデータがFirestoreに正しく保存されているか確認
     - 6月データ（2025-W21〜W25）の存在確認
   - [ ] **必要に応じてデータ再生成**

### 優先度: 中
2. **週キー変換ロジックの動作確認**
   - [ ] 変更したロジックが正しく動作しているか確認
   - [ ] 実データでのテスト実行

### 優先度: 低
3. **全体的なデータ整合性確認**
   - [ ] 他の月のデータも正しく表示されるか確認
   - [ ] 週キー形式の統一化検討

## 6. 技術的詳細 (Technical Details)
### 現在の実装状況
- **週キー変換ロジック**: `app/api/recruitment/optimized-weekly-summaries/route.ts` L85-94
- **デバッグログ**: 2025年データの一覧表示機能追加済み
- **利用可能データ**: 2025-W01〜W10 (1月4日〜3月8日)

### 検証が必要な項目
- データ生成スクリプト: `scripts/generate-optimized-weekly-summaries.ts`
- 週計算ロジック: `lib/analytics/weekly-aggregation.ts`
- UI側の週キー生成: `hooks/use-optimized-weekly-summaries.ts` 