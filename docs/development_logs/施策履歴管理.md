# 機能開発: 施策履歴管理機能

## 1. 概要
**現象**: 現在の施策タブでは最新版しか見れず、過去実施したものや施策自体の振り返りがしにくい
**要望**: 
- 各施策の履歴を表示できるようにする
- 何をするのか、何をして、どうなったかを見やすく管理したい
- カテゴリ分けによるフィルタリング機能を追加したい

## 2. 現状分析
**現在の実装**: 
- `components/initiatives-dashboard.tsx`: 単純なリストビューで最新版のみ表示
- データは状態管理（useState）のみ、永続化なし
- カテゴリ分けなし、基本的なフィルタのみ

**問題点**:
- 履歴が残らない（更新すると前の状態が失われる）
- 施策の進捗や変化を追跡できない
- カテゴリによる整理ができない

## 3. 実装タスクリスト

### 3.1 データ構造設計
- [x] **データ定義書更新**: `docs/specifications/03_data_definition.md`に施策関連構造を追加
  - [x] `initiatives`コレクション定義
  - [x] `initiative_versions`コレクション定義  
  - [x] 列挙型定義（InitiativeStatus, InitiativeCategory, Priority）
- [x] **型定義作成**: `lib/types/initiative.ts`で完全な型定義

### 3.2 バックエンド実装
- [x] **Firestore操作**: `lib/firestore/initiatives.ts`
  - [x] 施策CRUD操作
  - [x] バージョン履歴管理
  - [x] フィルタリング・検索機能
- [x] **API実装**: `app/api/initiatives/`
  - [x] 施策一覧取得 (`route.ts`)
  - [x] 施策作成・更新・削除 (`[id]/route.ts`)
  - [x] 履歴取得 (`[id]/history/route.ts`)

### 3.3 フロントエンド実装
- [x] **施策ダッシュボード拡張**: `components/initiatives-dashboard-v2.tsx`
  - [x] カテゴリフィルタ追加
  - [x] 履歴表示機能
  - [x] バージョン比較機能
  - [x] サイドパネル方式のUI実装
- [x] **メインページ統合**: `app/page.tsx`で新ダッシュボード使用

### 3.4 その他
- [x] **サンプルデータ移行スクリプト**: `scripts/migrate-sample-initiatives.ts`
- [ ] **データ移行実行**: スクリプトを実行してサンプルデータをFirestoreに投入
- [ ] **UIテスト**: `docs/development_logs/UI_TEST_CHECKLIST.md`に基づく手動テスト
- [ ] **ドキュメント更新**: README等の更新

## 4. 設計方針

### 4.1 履歴管理の仕組み
- **メイン施策**（`initiatives`）: タイトル、カテゴリ、基本情報を管理
- **バージョン履歴**（`initiative_versions`）: 各変更時の詳細内容を記録
- **変更時の動作**: 施策更新時に新しいバージョンを自動作成

### 4.2 カテゴリ分類
- 採用関連、稼働者管理、システム改善、業務改善、マーケティング、その他
- フィルタリングと統計表示に活用

### 4.3 履歴表示方法
- タイムライン形式での変更履歴表示
- バージョン間の差分表示機能
- 変更理由の記録と表示

## 5. UI/UX設計

### 5.1 施策リスト画面
- 現在の表示 + カテゴリフィルタ
- 各施策カードに「履歴を見る」ボタン追加

### 5.2 履歴表示画面
- タイムライン形式で変更履歴を表示
- 各バージョンで「課題→原因→アクション→結果」の流れを可視化
- バージョン間比較機能

### 5.3 編集機能
- 変更時に変更理由の入力を必須化
- 重要な変更時は確認ダイアログ表示

## 6. 実装順序
1. **データ構造** (完了)
2. **Firestore操作関数**
3. **API実装** 
4. **フロントエンド機能拡張**
5. **データ移行とテスト**

## 7. 進捗記録

- **2025-01-22 15:30**: 開発ログ作成、データ構造設計完了
- **2025-01-22 16:00**: バックエンド実装完了（Firestore操作 + API）
- **2025-01-22 16:15**: ユーティリティ関数実装完了（差分比較、表示用ヘルパー）
- **2025-01-22 16:30**: サイドパネル式UIコンポーネント設計完了
- **2025-01-22 16:45**: サンプルデータ移行スクリプト作成完了
- **2025-01-22 16:50**: メインページ統合完了、実装フェーズ完了
- **2025-01-22 17:00**: データ移行でFirestoreエラー発生、モックデータによるUI動作確認に切り替え
- **2025-01-22 17:05**: 開発サーバー動作確認完了（http://localhost:3000 → 200 OK）
- **Next**: ブラウザでのUI動作確認 → 機能テスト実行

## 8. 現在の実装状況

### ✅ 完了項目
- **データ構造設計**: Firestore スキーマ定義、型定義、列挙型すべて完備
- **バックエンドAPI**: 3つのエンドポイント実装完了
- **フロントエンド**: サイドパネル方式のUI、フィルタ機能、履歴表示、差分比較機能
- **統合**: メインページでの新ダッシュボード使用
- **開発環境**: サーバー起動確認済み

### ⚠️ 一時保留項目
- **データ移行**: Firestore書き込みエラー（enum値の日本語対応問題の可能性）
- **解決策**: モックデータでのUI確認を優先、Firestoreは後で修正

### 📋 次のアクション（ブラウザ確認項目）
1. http://localhost:3000 アクセス
2. 施策タブクリック 
3. 機能動作確認：
   - [ ] 施策一覧の表示
   - [ ] カテゴリ・ステータス・優先度フィルタ
   - [ ] 検索機能
   - [ ] 詳細パネルの4項目表示（課題→原因→アクション→結果）
   - [ ] 履歴タイムライン表示
   - [ ] バージョン比較機能
   - [ ] レスポンシブデザイン 