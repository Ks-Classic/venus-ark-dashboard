# SOW: オンデマンド週次レポート更新機能の実装 (Phase 2)

## 1. 背景と目的

現在、採用ダッシュボードの週次レポート(`weekly_reports`)は、手動スクリプトの実行、またはスプレッドシートからの全体同期によってのみ更新される。しかし、日々の運用において、特定の週のデータのみを迅速に最新の状態に更新したいというニーズが存在する。
本作業は、ユーザーがダッシュボードUIから直接、表示している週のレポートのみを再集計・更新できる機能を実装し、データ鮮度と運用効率を向上させることを目的とする。

## 2. 作業範囲 (Scope of Work)

本SOWが対象とする作業範囲は以下の通りである。

### 2.1. バックエンド開発

-   **APIエンドポイントの作成:**
    -   `POST /api/recruitment/generate-weekly-report` を新規に作成する。
    -   リクエストボディで更新対象の週 (`year`, `month`, `weekInMonth`) のリストを受け取る。
    -   指定された週のデータを `applications` コレクションから取得し、`lib/analytics/weekly-aggregation.ts` のロジックを再利用して週次レポートを再計算する。
    -   計算結果を `weekly_reports` コレクションに上書き保存する。
    -   処理の成功または失敗を示すレスポンスを返す。

### 2.2. フロントエンド開発

-   **UIコンポーネントの追加:**
    -   `components/recruitment-dashboard.tsx` 内の「データ管理」セクションに `[表示週を再集計]` ボタンを新たに追加する。
-   **状態管理とAPI連携:**
    -   ボタンクリック時に、現在表示されている週の情報を取得する。
    -   作成したAPIエンドポイント (`/api/recruitment/generate-weekly-report`) にPOSTリクエストを送信する。
    -   API処理中は、ボタンを無効化し、ローディングスピナ���などを表示して、ユーザーに処理中であることをフィードバックする。
    -   APIから成功レスポンスを受け取った後、SWRのキャッシュを再検証 (`mutate`) させ、画面の表示を自動的に最新の状態に更新する。
    -   エラーが発生した場合は、トースト通知などでユーザーにエラーを知らせる。

### 2.3. ドキュメント

-   本SOWの作成をもって、事前ドキュメントの更新は完了とする。
-   実装完了後、必要に応じてREADMEや運用マニュアルに本機能に関する記述を追記する。

## 3. 作業範囲外 (Out of Scope)

以下の項目は本SOWの範囲外とする。

-   スプレッドシートから`applications`へのデータ同期機能の改修。
-   レポートの集計ロジック (`lib/analytics/weekly-aggregation.ts`) の変更。
-   レポートの自動更新機能（定期実行）の実装。
-   UIデザインの大幅な変更。
-   単体テストおよびE2Eテストコードの作成。

## 4. 成果物

1.  **ソースコード:**
    -   機能実装が完了し、指定ブランチにマ��ジされたフロントエンドおよびバックエンドのコード。
2.  **ドキュメント:**
    -   本SOW (`docs/SOW_Implementation_Phase_2.md`)。

## 5. 前提条件

-   `applications` コレクションには、レポート集計の元となるデータがスプレッドシートから同期済みであること。
-   既存の `weekly_reports` 表示機能、および `useWeeklyReports` フックは正常に動作していること。

## 6. 承認

| 役割 | 氏名 | 署名 | 日付 |
| :--- | :--- | :--- | :--- |
| プロダクトオーナー | | | |
| 開発リード | | | |

## 7. 開発上の絶対的ルール
本件の開発は、プロジェクトの品質と一貫性を担保するため、以下のルールファイルに厳密に従うものとする。
- **参照必須ファイル:** `docs/GEMINI_RULES.md`

特に、ルール2.1に定義された**「『表示週の再集計』は必ず1週間のみを対象とする」**という要件は、本SOWの最重要事項である。
